##
#
# TEORIA
#
##

# PV = phisical volume = volume fisico = sao os discos rigidos 
# propriamente ditos
#
# VG = volume group = grupo de volume = consiste no agrupamento
# de PVs. basicamente consiste na reuniao de varios discos rigidos
# para formar um ou mais grupos.
#
# LV = logical volume = volumes logicos = depois de reunir os varios
# discos rigidos em um ou mais grupos de volumes, agora podemos dividir
# esses varios grupos de volumes em vaios volumes logicos, como por
# exemplo, um volume para o samba, outro para paginas web (www) e assim
# por diante.
#
# para esse teste serao utilizado tres discos rigidos, /dev/sd[bcde]1
#

##
#
# INSTALCAO
#
##

#
# instalacao dos software necess√°rios
#
	$ sudo apt-get install lvm2 dmsetup mdadm xfsprogs
##
#
# FORMATACAO
#
##

# os discos deve ser particionados e formatados (8e) utilizando o
# aplicativo fdisk
#
    $ sudo fdisk /dev/sd[bcde]1

##
#
# PV
#
##

# 
# nessa etapa, serao criados os volumes fisicos.
#
	$ sudo pvcreate /dev/sd[bcd]1

#
# para desmontar um lvm, como ultima etapa, devesse
# apagar os volumes fisicos.
#
	$ sudo pvremove /dev/sd[bcd]1

#
# exibir informacoes sobre os volumes fisicos.
#
	$ sudo pvdisplay
	$ sudo pvdisplay /dev/sdXY

##
#
# VG
#
##

#
# depois de ser criado os volumes fisicos, a proxima etapa
# consiste em reunir esses volumes fisicos em um volume
# logico cujo nome no exemplo abaixo eh lvm_volume
#
	$ sudo vgcreate lvm_volume /dev/sd[bcd]1

#
# exibir informacoes sobre o(s) volume(s) logico(s)
#
	$ sudo vgdisplay
	$ sudo vgdisplay lvm_volume

#
# comando utilizado para renomear o volume logico criado
# na etapa anterior.
#
	$ sudo vgrename lvm_volume vg_data

#
# comando utilizado para apagar o volume logico criado anteriormente.
#
	$ sudo vgremove vg_data

##
#
# LV
#
##

#
# depois de criar os volumes fisicos e agrupar esses volumes fisicos
# um volume logico de nome vg_data, agora esse volume logico sera
# dividido em varios volumes logicos de acordo com as necessidade.
#
    $ sudo lvcreate --name samba --size 5G vg_data
    $ sudo lvcreate --name web --size 10G vg_data

#
# exibir informacoes sobre o volume logico
#
	$ sudo lvdisplay
	$ sudo lvscan

#
# renomvear o volume logico WEB para WWW
# 
	$ sudo lvrename vg_data web www 

#
# apagar o volume logico WWW
#
	$ sudo lvremove /dev/vg_data/www

#
# depois de criar os volumes logicos SAMBA e WWW
# eh necessario criar o sistema de arquivos e
# montar.
#

#
# formatar
#
	$ sudo mkfs -t ext4 /dev/vg_data/samba
	$ sudo mkfs -t ext4 /dev/vg_data/www

#
# montar
#
	$ sudo mkdir /mnt/samba
	$ sudo mkdir /mnt/www
	$ sudo mount /dev/vg_data/samba /mnt/samba
	$ sudo mount /dev/vg_data/www /mnt/www

#
# adicionar os volumes logicos montados no arquivo
# /etc/fstab para que toda vez que o computador for
# reinicializado, o mesmo seja montado de forma
# automatica.
#
	$ sudo blkid
	$ sudo vi /etc/fstab
	UUID=XYZ	/mnt/samba      ext4    defaults      0 2
	UUID=ABC	/mnt/www        ext4    defaults      0 2

##
# ADICIONAR UM NOVO DISCO RIGIDO AO VG_DATA
##

#
# procedimentos para adicionar um novo disco rigido
# ao VG_DATA
#
	$ sudo fdisk /dev/sdf   ; particionar o disco rigido
	$ sudo pvcreate /dev/sdf1   ; criar o volume fisico do novo disco rigido
	$ sudo vgextend vg_data /dev/sdf1   ; extender o VG com o novo disco rigido
	$ sudo vgdisplay

##
# AMPLIACAO
#
# neste caso, o sistema de arquivo NAO foi formatado e nem
# foi montado
#
# samba - de 5GB para 15GB
# web - de 10GB para 25GB
#
$ sudo lvextend -L15G /dev/vg_data/samba
$ sudo lvextend -L25G /dev/vg_data/web
$ sudo lvscan

##
# REDUCAO
#
# neste caso, o sistema de arquivo NAO foi formatado e nem
# foi montado
# 
# samba - de 15GB para 9GB
# web - de 25GB para 17GB
#
$ sudo lvreduce -L9G /dev/vg_data/samba
$ sudo lvreduce -L17G /dev/vg_data/web
$ sudo lvscan

##
# AMPLIACAO
#
# neste caso, o sistema de arquivo FOI formatado e
# foi montado
#
# samba - de 9GB para 15GB
# web - de 15GB para 25GB
#
$ sudo umount /mnt/samba/
$ sudo umount /mnt/web/

$ sudo lvextend -L15G /dev/vg_data/samba
$ sudo lvextend -L25G /dev/vg_data/web

$ sudo e2fsck -f /dev/vg_data/samba
$ sudo e2fsck -f /dev/vg_data/web

$ sudo resize2fs /dev/vg_data/samba
$ sudo resize2fs /dev/vg_data/web

$ sudo mount /mnt/samba/
$ sudo mount /mnt/web/

##
# REDUCAO
#
# neste caso, o sistema de arquivo FOI formatado e
# foi montado
#
# samba - de 15GB para 9GB
# web - de 25GB para 16GB
#
$ sudo umount /mnt/samba/
$ sudo umount /mnt/web/

$ sudo e2fsck -f /dev/vg_data/samba
$ sudo e2fsck -f /dev/vg_data/web

$ sudo resize2fs /dev/vg_data/samba 9216M
$ sudo resize2fs /dev/vg_data/web 16384M

$ sudo lvreduce -L9G /dev/vg_data/samba
$ sudo lvreduce -L16G /dev/vg_data/web

$ sudo mount /mnt/samba/
$ sudo mount /mnt/web/

##
#
# ADICIONANDO UM DISCO RIGIDO NO LVM
#
##

$ sudo pvcreate /dev/sde1
$ sudo vgextend vg_data /dev/sde1

##
#
# REMOVER UM DISCO RIGIDO NO LVM
#
##

$ sudo pvmove /dev/sdb1 /dev/sde1
$ sudo vgreduce vg_data /dev/sdb1
$ sudo pvremove /dev/sdb1

##
#
# REMOVER LVM DO COMPUTADOR
#
##
$ sudo umount /mnt/samba/
$ sudo umount /mnt/web/
$ sudo lvremove /dev/vg_data/samba 
$ sudo lvremove /dev/vg_data/web
$ sudo vgremove vg_data
$ sudo pvremove /dev/sd[cde]1
