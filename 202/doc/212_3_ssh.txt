#: Title : ssh
#: Author : "Caio Abreu Ferreira" <abreuferr_gmail.com>
#: Description : configuracao do servidor ssh e politicas de seguranca
#: Options : None

Description: Candidates should be able to configure and secure an SSH daemon. 
This objective includes managing keys and configuring SSH for users. Candidates 
should also be able to forward an application protocol over SSH and manage the SSH login.

Key Knowledge Areas:
- OpenSSH configuration files, tools and utilities
- Login restrictions for the superuser and the normal users
- Managing and using server and client keys to login with and without password
- Usage of multiple connections from multiple hosts to guard against loss of connection 
  to remote host following configuration changes

Terms and Utilities:
- ssh
- sshd
- /etc/ssh/sshd_config
- /etc/ssh/
- Private and public key files
- PermitRootLogin, PubKeyAuthentication, AllowUsers, PasswordAuthentication, Protocol

#
# SERVER - INSTALACAO
#

# atualizacao do gnu/linux debian
$ sudo apt-get update && sudo apt-get upgrade

# instalacao do opnssh
$ sudo apt-get install openssh-server openss-client ; instalacao

#
# SERVER - CONFIGURACAO - GERAL
#

# backup do arquivo de configuracao do ssh server
$ sudo cp /etc/ssh/sshd_config /etc/ssh/sshd_config.BKP

# configuracao
$ sudo vi /etc/ssh/sshd_config
	Port 22 # porta de trabalho do servidor ssh
	AllowUsers <USER> # limitar o acesso a determinados usuarios
	AllowGroups <GROUP> # limitar o acesso a determinado grupo de usuario
	DenyUsers <USER> # negar o acesso a determinados usuarios
	DenyGroups <GROUP> # negar o acesso a um determinado grupo de usuarios
	PermitRootLogin <NO/YES> # permitir ou nao o login do usuario root
	Protocol 2 # especifica qual o protocolo de seguranca a ser utilizado
	PermitEmptyPasswords <YES/NO> # permitir ou nao a utilizacao de senhas em branco
	ClientAliveInterval <NUM> # depois de X segundos sem nenhuma atividade, o usuario eh deslogado
	ClientAliveCountMax <NUM> # quantidade de mensagens enviadas pelo cliente
	X11Forwarding <YES/NO> # permitir ou nao o redirecionamento do X11 para o cliente

#
# SERVER - CONFIGURACAO - AUTENTICACAO VIA PAR DE CHAVES
#

# configuracao
$ sudo vi /etc/ssh/sshd_config
	# desabilita a autenticacao via senha.
	PasswordAuthentication no

	# desabilita o processo de challenge-response
	# no processo de autenticacao.	
	ChallengeResponseAuthentication no

	# utiliza a tecnologia PAM para executar o processo
	# de autenticacao.	
	UsePAM yes

# reinicializar o servidor ssh
$ sudo systemctl restart sshd.service

#
# CLIENT
#

# instalacao do client na estacao
$ sudo apt-get install openssh-client

# criando chaves de autenticacao
$ ssh-keygen -b 2048 -t rsa -C "cosmo@particula.local"

# criando a chave de autorizacao
$ cp ~/.ssh/id_rsa.pub ~/.ssh/authorized_keys

# chaves geradas
$ ls -l /home/cosmo/.ssh
	# chave privada
	-rw------- 1 cosmo cosmo 1766 Jan 11 13:36 id_rsa
	# chave publica
	-rw-r--r-- 1 cosmo cosmo  403 Jan 11 13:36 id_rsa.pub

# copiando a chave publica para o servidor
$ ssh-copy-id <USERNAME@SERVER>
