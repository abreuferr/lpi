#: Title : E-Mail Services
#: Author : "Caio Abreu Ferreira" <abreuferr_gmail.com>
#: Description : Using e-mail servers
#: Options : Weight: 2

Description: Candidates should be able to install and configure POP and IMAP daemons.

Key Knowledge Areas:
- Dovecot IMAP and POP3 configuration and administration
- Basic configuration for Dovecot
- Awareness of Courier

Terms and Utilities:
- /etc/dovecot/
- dovecot.conf
- doveconf
- doveadm

#
# INSTALCAO
#

# atualizacao do gnu/linux debian
$ sudo apt-get update
$ sudo apt-get upgrade -y -d

# instalacao do postfix
$ sudo apt-get install postfix mailutils telnet -y -d

# instalacao do dovecot
$ sudo apt-get install dovecot-core dovecot-imapd dovecot-pop3d -y -d

#
# CONFIGURACAO
#

# configurando o Postfix para trabalhar com o Dovecot.
$ sudo vi /etc/postfix/main.cf
	smtpd_sasl_type = dovecot
	smtpd_sasl_path = private/auth
	smtpd_sasl_auth_enable = yes
	broken_sasl_auth_clients = yes

# configuracao a conexao do Dovecot.
$ sudo vi /etc/dovecot/dovecot.conf
	# lista de enderecos dos hosts que o dovecot
	# deve permitir conexao.
	listen = *, ::

# configurando o processo de autenticacao no
# Dovecot.
$ sudo vi /etc/dovecot/conf.d/10-auth.conf
	auth_mechanisms = plain login

# configurando o Maildir no Dovecot.
$ sudo vi /etc/dovecot/conf.d/10-mail.conf
	# indica a localizacao do mailbox do ususario.
	mail_location = maildir:~/Maildir

# configurando o Dovecot para trabalhar com o
# Postfix.
$ sudo vi /etc/dovecot/conf.d/10-master.conf
	service auth {
	  unix_listener /var/spool/postfix/private/auth {
	    mode = 0660
  	    user = postfix
	    group = postfix
 	  }
	}

# reinicializando o Postfix e o Dovecot
$ sudo systemctl restart postfix.service
$ sudo systemctl restart dovecot.service

#
# TESTE - POSTFIX/DOVECOT
#

# teste do postfix.
$ echo "Corpo do e-mail" | mail -s "Subject do e-mail" cosmo@particula.local

# teste smtp
$ telnet localhost 25
	ehlo localhost
	mail from: cosmo
	rcpt to: cosmo
	data
	subject: teste dovecot
	Mail body
	.
	quit

# teste dovecot imap
$ telnet localhost 143
	x1 LOGIN cosmo cosmo_password
	x2 LIST "" "*"
	x3 SELECT Inbox
	x4 LOGOUT

# teste de login no devecot
$ telnet localhost 143
	a login "[USERNAME]" "[PASSWORD]"
	b select inbox
	c list "" *
	d lsub "" *
	e logout

#
# ESTACAO
#

# instalacao do mutt
$ sudo apt-get install mutt -y -d

# criando pastas para armazenar o 
# certificado
$ mkdir -p .mutt/cache/headers
$ mkdir -p .mutt/cache/bodies
$ mkdir -p .mutt/certificates

# configuracao do mutt
$ vi .muttrc
	set imap_user = "cosmo"
	set imap_pass = "[SENHA]"

	# sem conexao segura
	set smtp_url = "smtp://cosmo@email.particula.local:25/"
	# com conexao segura
	set smtp_url = "smtp://cosmo@email.particula.local:465/"
	set smtp_pass = "[SENHA]"

	set ssl_starttls = yes
	set ssl_force_tls = yes

	set from = "cosmo@particula.local"
	set realname = "caio ferreira"

	# sem conexao segura
	set folder = "imaps://email.particula.local:143"
	# com conexao segura
	set folder = "imaps://email.particula.local:993"

	set spoolfile = "+INBOX"
	set postponed="+Drafts"

	# certificado digital
	set header_cache=~/.mutt/cache/headers
	set message_cachedir=~/.mutt/cache/bodies
	set certificate_file=~/.mutt/certificates
	set ssl_force_tls = yes
	set ssl_starttls = yes
