# DNS HOWTO - Guia Completo para Configura√ß√£o BIND9

**Autor:** Caio Abreu Ferreira <abreuferr_gmail.com>  
**Descri√ß√£o:** Criar e manter zonas DNS com BIND9  
**Peso:** 3  
**Refer√™ncias:**
- [BIND 9 Documentation](https://bind9.readthedocs.io/en/latest/introduction.html)
- [DNS & BIND Book](http://zytrax.com/books/dns/)

## √Åreas de Conhecimento Essenciais

- Arquivos de configura√ß√£o, termos e utilit√°rios do BIND 9
- Utilit√°rios para solicitar informa√ß√µes do servidor DNS
- Layout, conte√∫do e localiza√ß√£o dos arquivos de zona BIND
- M√©todos diversos para adicionar um novo host nos arquivos de zona, incluindo zonas reversas

## Termos e Utilit√°rios

- `/var/named/` ou `/etc/bind/` - Diret√≥rios principais de configura√ß√£o
- Sintaxe de arquivo de zona
- Formatos de registro de recursos (Resource Records)
- `named-checkzone` - Verifica√ß√£o de sintaxe de zona
- `named-compilezone` - Compila√ß√£o de zona
- Formato de arquivo prim√°rio
- `dig` - Ferramenta de consulta DNS mais vers√°til
- `nslookup` - Ferramenta de consulta DNS legacy
- `host` - Ferramenta simples de consulta DNS

---

## üìö Teoria Fundamental

### Servidores Autoritativos

Os **servidores autoritativos** s√£o respons√°veis por uma zona espec√≠fica e, consequentemente, pelos dados desta zona. Segundo a RFC 1035, uma zona sempre deve possuir pelo menos dois servidores autoritativos:

- **Servidor Prim√°rio (Master):** Mant√©m uma c√≥pia oficial dos dados da zona em disco
- **Servidor Secund√°rio (Slave):** Obt√©m seus dados do servidor prim√°rio atrav√©s de transfer√™ncia de zona

> **üí° Dica de Seguran√ßa:** Por motivos de disponibilidade e seguran√ßa, o servidor secund√°rio deve sempre ficar armazenado em uma rede diferente do prim√°rio.

### Tipos de Servidores DNS

- **Autoritativo:** Representantes oficiais de uma zona
- **Prim√°rio/Master:** Servidor principal de uma zona
- **Secund√°rio/Slave:** Servidor com c√≥pia do prim√°rio
- **Caching-only:** Servidor que apenas faz cache de consultas
- **Forwarder:** Servidor que encaminha consultas para outros servidores

---

## üîß Prepara√ß√£o do Ambiente

### Remo√ß√£o do AppArmor (Prim√°rio/Secund√°rio)

```bash
# Removendo o AppArmor para evitar conflitos de seguran√ßa
sudo apt autoremove --purge apparmor
```

> **‚ö†Ô∏è Importante:** A remo√ß√£o do AppArmor deve ser avaliada considerando as pol√≠ticas de seguran√ßa da organiza√ß√£o.

### Instala√ß√£o (Prim√°rio/Secund√°rio)

```bash
# Atualiza√ß√£o do sistema
sudo apt-get update && sudo apt-get upgrade

# Instala√ß√£o do BIND9 e ferramentas auxiliares
sudo apt-get install bind9 dnsutils bind9-doc -y

# Alterando permiss√µes para o usu√°rio bind
sudo chown -R bind:bind /etc/bind
```

> **üìù Nota:** O processo de instala√ß√£o deve ser executado tanto no servidor prim√°rio (ns1) quanto no secund√°rio (ns2).

---

## ‚öôÔ∏è Configura√ß√£o do Servidor

### Configura√ß√£o de Logging

A op√ß√£o `INCLUDE` permite segmentar a configura√ß√£o do BIND em m√∫ltiplos arquivos, facilitando a manuten√ß√£o:

```bash
# Backup da configura√ß√£o original
sudo cp /etc/bind/named.conf{,.origin}

# Editando configura√ß√£o principal
sudo vi /etc/bind/named.conf
```

Adicionar ao final do arquivo:
```
include "/etc/bind/named.conf.log";
```

**Arquivo de configura√ß√£o de log:**
```bash
sudo vi /etc/bind/named.conf.log
```

```
logging {
    channel bind_log {
        syslog daemon;
        severity info;
        print-category yes;
        print-severity yes;
        print-time yes;
    };
    category default { bind_log; };
    category update { bind_log; };
    category update-security { bind_log; };
    category security { bind_log; };
    category queries { bind_log; };
    category lame-servers { null; };
};
```

**Reinicializa√ß√£o do servi√ßo:**
```bash
sudo systemctl restart bind9
```

### Op√ß√µes para Visualizar Logs

```bash
# Logs do BIND em tempo real
sudo journalctl -u named -f

# √öltimas 20 linhas dos logs
sudo journalctl -u named -n 20

# Logs do BIND de hoje
sudo journalctl -u named --since today

# Logs com filtro por categoria
sudo journalctl -u named | grep -E "(queries|security|update)"

# Todos os logs do sistema em tempo real
sudo journalctl -f
```

---

## üñ•Ô∏è Configura√ß√£o do Servidor Prim√°rio

### Configura√ß√£o de Op√ß√µes Globais

```bash
# Backup da configura√ß√£o original
sudo cp /etc/bind/named.conf.options{,.origin}

sudo vi /etc/bind/named.conf.options
```

```
// ACL para controle de acesso √†s consultas DNS
acl rede {
    // Rede autorizada para resolu√ß√£o de nomes
    192.168.0.0/24;
};

options {
    // Diret√≥rio de trabalho do servidor
    directory "/var/cache/bind";

    // Ocultar vers√£o do BIND por seguran√ßa
    version none;

    // Interface e porta de escuta
    listen-on port 53 { localhost; rede; };

    // Controle de consultas permitidas
    allow-query { rede; };

    // Permitir recurs√£o apenas para rede local
    // Para DNS p√∫blico, remover esta op√ß√£o
    allow-recursion { rede; };

    // Configura√ß√µes de seguran√ßa adicionais
    recursion yes;
    allow-query-cache { rede; };
    
    // Rate limiting para prevenir ataques DDoS
    rate-limit {
        responses-per-second 5;
        window 5;
    };
};
```

**Valida√ß√£o da configura√ß√£o:**
```bash
sudo named-checkconf /etc/bind/named.conf.options
```

### Configura√ß√£o de Zonas

```bash
sudo cp /etc/bind/named.conf.local{,.origin}
sudo vi /etc/bind/named.conf.local
```

```
// Configura√ß√£o da zona direta particula.local
zone "particula.local" in {
    // Tipo de servidor (master/primary)
    type master;

    // Arquivo de configura√ß√£o da zona
    file "/etc/bind/db.particula.local";

    // Permite transfer√™ncia de zona para o secund√°rio
    allow-transfer { 192.168.0.6; };

    // Notifica√ß√£o autom√°tica de altera√ß√µes
    notify yes;

    // Configura√ß√µes adicionais de seguran√ßa
    also-notify { 192.168.0.6; };
    check-names fail;
};

// Configura√ß√£o da zona reversa
zone "0.168.192.in-addr.arpa" in {
    type master;
    file "/etc/bind/db.0.168.192";
    allow-transfer { 192.168.0.6; };
    notify yes;
    also-notify { 192.168.0.6; };
    check-names fail;
};
```

**Valida√ß√£o da configura√ß√£o:**
```bash
sudo named-checkconf /etc/bind/named.conf.local
```

### Arquivo de Zona Direta

```bash
sudo vi /etc/bind/db.particula.local
```

```
// Configura√ß√£o TTL padr√£o (3 dias)
$TTL 3D

// Start of Authority - Define par√¢metros da zona
@ IN SOA ns1.particula.local. root.particula.local. (
    // N√∫mero serial - DEVE ser incrementado a cada altera√ß√£o
    // Formato recomendado: YYYYMMDDNN
    2024061401  ; Serial
    
    // Intervalo de refresh (8 horas)
    8H          ; Refresh
    
    // Intervalo de retry em caso de falha (2 horas)  
    2H          ; Retry
    
    // Tempo de expira√ß√£o (4 semanas)
    4W          ; Expire
    
    // TTL negativo (1 dia)
    1D          ; Negative Cache TTL
)

; Registros de Name Server (NS)
@   IN NS ns1.particula.local.
@   IN NS ns2.particula.local.

; Registros de Mail Exchange (MX) - Prioridade crescente
    IN MX 10 mail1.particula.local.
    IN MX 20 mail2.particula.local.

; Registros A - Associa√ß√£o hostname para IP
    IN A 192.168.0.5
    IN A 192.168.0.6

ns1     IN A 192.168.0.5
ns2     IN A 192.168.0.6

mail1   IN A 192.168.0.7
mail2   IN A 192.168.0.8

; Balanceamento de carga - M√∫ltiplos IPs para mesmo hostname
ftp     IN A 192.168.0.9
        IN A 192.168.0.10

; Registro CNAME - Alias/Apelido
www     IN CNAME srv

; Registros adicionais para servi√ßos
srv     IN A 192.168.0.11
db      IN A 192.168.0.12

; Registro TXT para verifica√ß√µes e pol√≠ticas
@       IN TXT "v=spf1 include:_spf.google.com ~all"
```

**Valida√ß√£o do arquivo de zona:**
```bash
sudo named-checkzone particula.local /etc/bind/db.particula.local
```

### Arquivo de Zona Reversa

```bash
sudo vi /etc/bind/db.0.168.192
```

```
$TTL 3D
$ORIGIN 0.168.192.IN-ADDR.ARPA.

@ IN SOA ns1.particula.local. root.particula.local. (
    2024061401  ; Serial
    8H          ; Refresh
    2H          ; Retry
    4W          ; Expire
    1D          ; Negative Cache TTL
)

; Registros NS
    IN NS ns1.particula.local.
    IN NS ns2.particula.local.

; Registros PTR - Resolu√ß√£o reversa (IP para hostname)
5   IN PTR ns1.particula.local.
6   IN PTR ns2.particula.local.
7   IN PTR mail1.particula.local.
8   IN PTR mail2.particula.local.
9   IN PTR ftp.particula.local.
10  IN PTR ftp.particula.local.
11  IN PTR srv.particula.local.
12  IN PTR db.particula.local.
```

**Valida√ß√£o da zona reversa:**
```bash
sudo named-checkzone 0.168.192.in-addr.arpa /etc/bind/db.0.168.192
```

### Aplica√ß√£o das Configura√ß√µes

```bash
# Recarregar configura√ß√µes sem reiniciar o servi√ßo
sudo rndc reload

# Verificar status
sudo systemctl status bind9
```

### Configura√ß√£o do Resolv.conf

```bash
sudo vi /etc/resolv.conf
```

```
domain particula.local
search particula.local
nameserver 192.168.0.5
nameserver 192.168.0.6
```

---

## üîÑ Configura√ß√£o do Servidor Secund√°rio (ns2)

### Configura√ß√£o de Op√ß√µes

```bash
sudo cp /etc/bind/named.conf.options{,.origin}
sudo vi /etc/bind/named.conf.options
```

```
acl rede {
    192.168.0.0/24;
};

options {
    directory "/var/cache/bind";
    version none;
    listen-on port 53 { localhost; rede; };
    
    // Desabilita transfer√™ncia de zona n√£o autorizada
    allow-transfer { rede; };
    allow-query { rede; };
    allow-recursion { localhost; rede; };
    
    // Configura√ß√µes espec√≠ficas para servidor secund√°rio
    recursion yes;
    notify no;  // Secund√°rio n√£o notifica outros servidores
};
```

### Configura√ß√£o de Zonas Secund√°rias

```bash
sudo cp /etc/bind/named.conf.local{,.origin}
sudo vi /etc/bind/named.conf.local
```

```
// Zona direta como secund√°ria
zone "particula.local" IN {
    type slave;
    file "db.particula.local";
    masters { 192.168.0.5; };
    allow-notify { 192.168.0.5; };
    
    // Configura√ß√µes adicionais para servidor secund√°rio
    max-transfer-time-in 60;
};

// Zona reversa como secund√°ria
zone "0.168.192.in-addr.arpa" IN {
    type slave;
    file "db.0.168.192";
    masters { 192.168.0.5; };
    allow-notify { 192.168.0.5; };
    max-transfer-time-in 60;
};
```

**Valida√ß√£o e aplica√ß√£o:**
```bash
sudo named-checkconf /etc/bind/named.conf.local
sudo systemctl restart bind9.service
```

### Configura√ß√£o do Resolv.conf (Secund√°rio)

```bash
sudo vi /etc/resolv.conf
```

```
domain particula.local
search particula.local
nameserver 192.168.0.5
nameserver 192.168.0.6
```

---

## üì° Transfer√™ncia de Zona

### Conceitos de Transfer√™ncia

A **transfer√™ncia de zona** √© o processo de sincroniza√ß√£o dos dados entre servidores prim√°rio e secund√°rio:

#### AXFR (Full Zone Transfer)
- Transfer√™ncia completa de todos os registros da zona
- Utilizada na primeira sincroniza√ß√£o ou quando h√° muitas altera√ß√µes
- Consome mais largura de banda

#### IXFR (Incremental Zone Transfer) 
- Transfer√™ncia apenas das diferen√ßas entre vers√µes
- Mais eficiente para pequenas altera√ß√µes
- Baseada no n√∫mero serial da zona

### Monitoramento da Transfer√™ncia

```bash
# Visualizar logs de transfer√™ncia
sudo journalctl -u named | grep -i transfer

# Exemplo de log de transfer√™ncia bem-sucedida:
# ns1 named[622]: zone particula.local/IN: sending notifies (serial 2024061401)
# ns1 named[622]: client 192.168.0.6#51219: transfer of 'particula.local/IN': AXFR-style IXFR started
# ns1 named[622]: client 192.168.0.6#51219: transfer of 'particula.local/IN': AXFR-style IXFR ended
```

---

## üîç Ferramentas de Consulta DNS

### NSLOOKUP

```bash
# Consulta b√°sica de registro A
nslookup particula.local

# Consulta reversa
nslookup 192.168.0.5

# Consulta de host espec√≠fico
nslookup web1.particula.local

# Consulta de registros NS
nslookup -query=ns particula.local

# Modo debug
nslookup -debug particula.local

# Consulta interativa
nslookup
> set type=MX
> particula.local
> exit
```

### DIG (Recomendado)

```bash
# Consulta de registro A
dig particula.local A

# Consulta de registro MX
dig particula.local MX

# Consulta de registro SOA
dig particula.local SOA

# Consulta de TTL
dig particula.local TTL

# Todos os registros (formato limpo)
dig particula.local ANY +noall +answer

# Consulta com servidor espec√≠fico
dig @192.168.0.5 particula.local

# Consulta reversa
dig -x 192.168.0.5

# Trace completo da consulta
dig +trace particula.local

# Consulta curta (apenas resposta)
dig +short particula.local A

# Consulta com estat√≠sticas
dig +stats particula.local
```

### HOST

```bash
# Sintaxe b√°sica
host [OPCAO] [DOMINIO]

# Op√ß√µes principais:
# -a - todos os protocolos
# -d - modo detalhado  
# -l [IP_NS] - transfer√™ncia de zona
# -t [REGISTRO] - tipo espec√≠fico (any, mx, ns, axfr, cname)
# -C - exibe registros SOA

# Exemplos pr√°ticos:
host ns1.particula.local
host www.particula.local  
host 192.168.0.5
host -t SOA particula.local
host -t MX particula.local
host -a particula.local
```

---

## üìä Monitoramento com TCPDUMP

### Captura de Consultas DNS

```bash
# Servidor ns1 - Capturar pacotes UDP porta 53
sudo tcpdump -i ens33 udp port 53 -w ns1.pcap

# Ler pacotes capturados
sudo tcpdump -n -t -r ns1.pcap port 53
```

**Exemplo de sa√≠da:**
```
# Host 192.168.0.42 consulta particula.local no NS 192.168.0.6
IP 192.168.0.42.59361 > 192.168.0.6.53: A? particula.local.

# NS 192.168.0.6 responde com IP da zona
IP 192.168.0.6.53 > 192.168.0.42.59361: A 192.168.0.6
```

### Monitoramento de Transfer√™ncia de Zona

```bash
# Capturar transfer√™ncias TCP (porta 53)
sudo tcpdump -i ens33 tcp port 53 -w transferencia.pcap

# Analisar transfer√™ncia AXFR
sudo tcpdump -n -t -r transferencia.pcap port 53 | grep AXFR
```

**Processo de transfer√™ncia observado:**
1. Servidor secund√°rio conecta via TCP
2. Solicita AXFR da zona
3. Prim√°rio transfere todos os registros
4. Conex√£o √© encerrada

---

## üõ†Ô∏è Utilit√°rios de Administra√ß√£o

### RNDC (Remote Name Daemon Control)

```bash
# Comandos principais do rndc:

# Exibir estat√≠sticas
sudo rndc stats
sudo rndc status

# Recarregar configura√ß√µes
sudo rndc reload

# Recarregar zona espec√≠fica
sudo rndc reload particula.local

# Parar o BIND
sudo rndc stop

# Parar sem salvar altera√ß√µes pendentes
sudo rndc halt

# Limpar cache
sudo rndc flush

# Reler apenas configura√ß√µes (n√£o zonas)
sudo rndc reconfig

# Dump do cache
sudo rndc dumpdb

# Estat√≠sticas detalhadas
sudo rndc recursing
sudo rndc querylog
```

### Comandos de Verifica√ß√£o

```bash
# Verificar sintaxe da configura√ß√£o principal
sudo named-checkconf

# Verificar configura√ß√£o espec√≠fica
sudo named-checkconf /etc/bind/named.conf.local

# Verificar zona espec√≠fica
sudo named-checkzone particula.local /etc/bind/db.particula.local

# Verificar todas as zonas
sudo named-checkconf -z
```

---

## üîí Configura√ß√µes de Seguran√ßa

### Oculta√ß√£o da Vers√£o do BIND

```bash
# Testar vers√£o atual (antes da prote√ß√£o)
dig +short @particula.local version.bind txt chaos
```

**Resultado sem prote√ß√£o:**
```
"9.18.12-0ubuntu0.22.04.1-Ubuntu"
```

**Configura√ß√£o de seguran√ßa em `/etc/bind/named.conf.options`:**
```
options {
    version none;           // Oculta vers√£o
    hostname none;          // Oculta hostname
    server-id none;         // Oculta server-id
};
```

**Ap√≥s aplicar configura√ß√£o:**
```bash
sudo rndc reload
dig +short @particula.local version.bind txt chaos
# Resultado: Nenhuma informa√ß√£o retornada
```

### Configura√ß√µes Adicionais de Seguran√ßa

```bash
# Adicionar ao named.conf.options:
options {
    // Desabilitar recurs√£o para consultas externas
    allow-recursion { localhost; rede; };
    
    // Rate limiting contra ataques DDoS
    rate-limit {
        responses-per-second 5;
        window 5;
    };
    
    // Desabilitar transfer√™ncia de zona n√£o autorizada
    allow-transfer { none; };
    
    // Logging de consultas suspeitas
    querylog yes;
    
    // Desabilitar notifica√ß√µes n√£o solicitadas
    notify no;
    
    // Configura√ß√µes de cache seguro
    max-cache-size 256M;
    cleaning-interval 60;
};
```

### Hardening do Sistema

```bash
# Configurar firewall para DNS
sudo ufw allow 53/udp
sudo ufw allow 53/tcp

# Monitoramento de logs suspeitos
sudo tail -f /var/log/syslog | grep named

# Verificar processos do BIND
ps aux | grep named

# Monitorar conex√µes ativas
sudo netstat -tulnp | grep :53
```

---

## üö® Solu√ß√£o de Problemas Comuns

### Problemas de Configura√ß√£o

```bash
# 1. Verificar sintaxe dos arquivos
sudo named-checkconf
sudo named-checkzone particula.local /etc/bind/db.particula.local

# 2. Verificar logs de erro
sudo journalctl -u named -f

# 3. Testar conectividade
dig @localhost particula.local
dig @192.168.0.5 particula.local

# 4. Verificar permiss√µes
ls -la /etc/bind/
sudo chown -R bind:bind /etc/bind/

# 5. Verificar portas em uso
sudo netstat -tulnp | grep :53
```

### Problemas de Transfer√™ncia de Zona

```bash
# 1. Verificar configura√ß√£o de allow-transfer
grep -r "allow-transfer" /etc/bind/

# 2. Testar transfer√™ncia manual
dig @192.168.0.5 particula.local AXFR

# 3. Verificar logs no servidor prim√°rio
sudo journalctl -u named | grep -i transfer

# 4. Verificar serial numbers
dig @192.168.0.5 particula.local SOA
dig @192.168.0.6 particula.local SOA
```

### Comandos de Diagn√≥stico

```bash
# Status completo do servi√ßo
sudo systemctl status bind9 -l

# Teste de resolu√ß√£o local
nslookup particula.local localhost

# Verificar cache
sudo rndc dumpdb
sudo cat /var/cache/bind/named_dump.db

# Monitor de consultas em tempo real
sudo tcpdump -i any port 53 -n
```

---

## üìã Checklist de Implementa√ß√£o

### Servidor Prim√°rio
- [ ] Instalar BIND9 e ferramentas
- [ ] Configurar named.conf.options
- [ ] Configurar named.conf.local
- [ ] Criar arquivo de zona direta
- [ ] Criar arquivo de zona reversa
- [ ] Configurar logging
- [ ] Aplicar configura√ß√µes de seguran√ßa
- [ ] Testar resolu√ß√£o local

### Servidor Secund√°rio  
- [ ] Instalar BIND9 e ferramentas
- [ ] Configurar como servidor slave
- [ ] Configurar transfer√™ncia de zona
- [ ] Verificar sincroniza√ß√£o
- [ ] Testar resolu√ß√£o local

### Testes Finais
- [ ] Consultas DNS funcionais
- [ ] Transfer√™ncia de zona operacional
- [ ] Logs sem erros
- [ ] Seguran√ßa implementada
- [ ] Documenta√ß√£o atualizada

---

## üìö Refer√™ncias e Recursos Adicionais

- [ISC BIND 9 Administrator Reference Manual](https://bind9.readthedocs.io/)
- [RFC 1035 - Domain Names Implementation](https://tools.ietf.org/html/rfc1035)
- [DNS Security Extensions (DNSSEC)](https://tools.ietf.org/html/rfc4033)
- [BIND 9 Security Considerations](https://kb.isc.org/docs/bind-9-security-considerations)

> **üí° Manuten√ß√£o:** Lembre-se sempre de incrementar o n√∫mero serial ao fazer altera√ß√µes nas zonas e manter backups regulares das configura√ß√µes.