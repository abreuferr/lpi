# DNS HOWTO - Guia Completo para ConfiguraÃ§Ã£o BIND9

**Autor:** Caio Abreu Ferreira <abreuferr_gmail.com>  
**DescriÃ§Ã£o:** Criar e manter zonas DNS com BIND9  
**Peso:** 3  
**ReferÃªncias:**
- [BIND 9 Documentation](https://bind9.readthedocs.io/en/latest/introduction.html)
- [DNS & BIND Book](http://zytrax.com/books/dns/)

## Ãreas de Conhecimento Essenciais

- Arquivos de configuraÃ§Ã£o, termos e utilitÃ¡rios do BIND 9
- UtilitÃ¡rios para solicitar informaÃ§Ãµes do servidor DNS
- Layout, conteÃºdo e localizaÃ§Ã£o dos arquivos de zona BIND
- MÃ©todos diversos para adicionar um novo host nos arquivos de zona, incluindo zonas reversas

## Termos e UtilitÃ¡rios

- `/var/named/` ou `/etc/bind/` - DiretÃ³rios principais de configuraÃ§Ã£o
- Sintaxe de arquivo de zona
- Formatos de registro de recursos (Resource Records)
- `named-checkzone` - VerificaÃ§Ã£o de sintaxe de zona
- `named-compilezone` - CompilaÃ§Ã£o de zona
- Formato de arquivo primÃ¡rio
- `dig` - Ferramenta de consulta DNS mais versÃ¡til
- `nslookup` - Ferramenta de consulta DNS legacy
- `host` - Ferramenta simples de consulta DNS

---

## ğŸ“š Teoria Fundamental

### Servidores Autoritativos

Os **servidores autoritativos** sÃ£o responsÃ¡veis por uma zona especÃ­fica e, consequentemente, pelos dados desta zona. Segundo a RFC 1035, uma zona sempre deve possuir pelo menos dois servidores autoritativos:

- **Servidor PrimÃ¡rio (Master):** MantÃ©m uma cÃ³pia oficial dos dados da zona em disco
- **Servidor SecundÃ¡rio (Slave):** ObtÃ©m seus dados do servidor primÃ¡rio atravÃ©s de transferÃªncia de zona

> **ğŸ’¡ Dica de SeguranÃ§a:** Por motivos de disponibilidade e seguranÃ§a, o servidor secundÃ¡rio deve sempre ficar armazenado em uma rede diferente do primÃ¡rio.

### Tipos de Servidores DNS

- **Autoritativo:** Representantes oficiais de uma zona
- **PrimÃ¡rio/Master:** Servidor principal de uma zona
- **SecundÃ¡rio/Slave:** Servidor com cÃ³pia do primÃ¡rio
- **Caching-only:** Servidor que apenas faz cache de consultas
- **Forwarder:** Servidor que encaminha consultas para outros servidores

---

## ğŸ”§ PreparaÃ§Ã£o do Ambiente

### RemoÃ§Ã£o do AppArmor (PrimÃ¡rio/SecundÃ¡rio)

```bash
# Removendo o AppArmor para evitar conflitos de seguranÃ§a
sudo apt autoremove --purge apparmor
```

> **âš ï¸ Importante:** A remoÃ§Ã£o do AppArmor deve ser avaliada considerando as polÃ­ticas de seguranÃ§a da organizaÃ§Ã£o.

### InstalaÃ§Ã£o (PrimÃ¡rio/SecundÃ¡rio)

```bash
# AtualizaÃ§Ã£o do sistema
sudo apt-get update && sudo apt-get upgrade

# InstalaÃ§Ã£o do BIND9 e ferramentas auxiliares
sudo apt-get install bind9 dnsutils bind9-doc -y

# Alterando permissÃµes para o usuÃ¡rio bind
sudo chown -R bind:bind /etc/bind
```

> **ğŸ“ Nota:** O processo de instalaÃ§Ã£o deve ser executado tanto no servidor primÃ¡rio (ns1) quanto no secundÃ¡rio (ns2).

---

## âš™ï¸ ConfiguraÃ§Ã£o do Servidor

### ConfiguraÃ§Ã£o de Logging

A opÃ§Ã£o `INCLUDE` permite segmentar a configuraÃ§Ã£o do BIND em mÃºltiplos arquivos, facilitando a manutenÃ§Ã£o:

```bash
# Backup da configuraÃ§Ã£o original
sudo cp /etc/bind/named.conf{,.origin}

# Editando configuraÃ§Ã£o principal
sudo vi /etc/bind/named.conf
```

Adicionar ao final do arquivo:
```
include "/etc/bind/named.conf.log";
```

**Arquivo de configuraÃ§Ã£o de log:**
```bash
sudo vi /etc/bind/named.conf.log
```

```
logging {
    channel bind_log {
        syslog daemon;
        severity info;
        print-category yes;
        print-severity yes;
        print-time yes;
    };
    category default { bind_log; };
    category update { bind_log; };
    category update-security { bind_log; };
    category security { bind_log; };
    category queries { bind_log; };
    category lame-servers { null; };
};
```

**ReinicializaÃ§Ã£o do serviÃ§o:**
```bash
sudo systemctl restart bind9
```

### OpÃ§Ãµes para Visualizar Logs

```bash
# Logs do BIND em tempo real
sudo journalctl -u named -f

# Ãšltimas 20 linhas dos logs
sudo journalctl -u named -n 20

# Logs do BIND de hoje
sudo journalctl -u named --since today

# Logs com filtro por categoria
sudo journalctl -u named | grep -E "(queries|security|update)"

# Todos os logs do sistema em tempo real
sudo journalctl -f
```

---

## ğŸ–¥ï¸ ConfiguraÃ§Ã£o do Servidor PrimÃ¡rio

### ConfiguraÃ§Ã£o de OpÃ§Ãµes Globais

```bash
# Backup da configuraÃ§Ã£o original
sudo cp /etc/bind/named.conf.options{,.origin}

sudo vi /etc/bind/named.conf.options
```

```
// ACL para controle de acesso Ã s consultas DNS
acl rede {
    // Rede autorizada para resoluÃ§Ã£o de nomes
    192.168.0.0/24;
};

options {
    // DiretÃ³rio de trabalho do servidor
    directory "/var/cache/bind";

    // Ocultar versÃ£o do BIND por seguranÃ§a
    version none;

    // Interface e porta de escuta
    listen-on port 53 { localhost; rede; };

    // Controle de consultas permitidas
    allow-query { rede; };

    // Permitir recursÃ£o apenas para rede local
    // Para DNS pÃºblico, remover esta opÃ§Ã£o
    allow-recursion { rede; };

    // ConfiguraÃ§Ãµes de seguranÃ§a adicionais
    recursion yes;
    allow-query-cache { rede; };
    
    // Rate limiting para prevenir ataques DDoS
    rate-limit {
        responses-per-second 5;
        window 5;
    };
};
```

**ValidaÃ§Ã£o da configuraÃ§Ã£o:**
```bash
sudo named-checkconf /etc/bind/named.conf.options
```

### ConfiguraÃ§Ã£o de Zonas

```bash
sudo cp /etc/bind/named.conf.local{,.origin}
sudo vi /etc/bind/named.conf.local
```

```
// ConfiguraÃ§Ã£o da zona direta particula.local
zone "particula.local" in {
    // Tipo de servidor (master/primary)
    type master;

    // Arquivo de configuraÃ§Ã£o da zona
    file "/etc/bind/db.particula.local";

    // Permite transferÃªncia de zona para o secundÃ¡rio
    allow-transfer { 192.168.0.6; };

    // NotificaÃ§Ã£o automÃ¡tica de alteraÃ§Ãµes
    notify yes;

    // ConfiguraÃ§Ãµes adicionais de seguranÃ§a
    also-notify { 192.168.0.6; };
    check-names fail;
};

// ConfiguraÃ§Ã£o da zona reversa
zone "0.168.192.in-addr.arpa" in {
    type master;
    file "/etc/bind/db.0.168.192";
    allow-transfer { 192.168.0.6; };
    notify yes;
    also-notify { 192.168.0.6; };
    check-names fail;
};
```

**ValidaÃ§Ã£o da configuraÃ§Ã£o:**
```bash
sudo named-checkconf /etc/bind/named.conf.local
```

### Arquivo de Zona Direta

```bash
sudo vi /etc/bind/db.particula.local
```

```
// ConfiguraÃ§Ã£o TTL padrÃ£o (3 dias)
$TTL 3D

// Start of Authority - Define parÃ¢metros da zona
@ IN SOA ns1.particula.local. root.particula.local. (
    // NÃºmero serial - DEVE ser incrementado a cada alteraÃ§Ã£o
    // Formato recomendado: YYYYMMDDNN
    2024061401  ; Serial
    
    // Intervalo de refresh (8 horas)
    8H          ; Refresh
    
    // Intervalo de retry em caso de falha (2 horas)  
    2H          ; Retry
    
    // Tempo de expiraÃ§Ã£o (4 semanas)
    4W          ; Expire
    
    // TTL negativo (1 dia)
    1D          ; Negative Cache TTL
)

; Registros de Name Server (NS)
@   IN NS ns1.particula.local.
@   IN NS ns2.particula.local.

; Registros de Mail Exchange (MX) - Prioridade crescente
    IN MX 10 mail1.particula.local.
    IN MX 20 mail2.particula.local.

; Registros A - AssociaÃ§Ã£o hostname para IP
    IN A 192.168.0.5
    IN A 192.168.0.6

ns1     IN A 192.168.0.5
ns2     IN A 192.168.0.6

mail1   IN A 192.168.0.7
mail2   IN A 192.168.0.8

; Balanceamento de carga - MÃºltiplos IPs para mesmo hostname
ftp     IN A 192.168.0.9
        IN A 192.168.0.10

; Registro CNAME - Alias/Apelido
www     IN CNAME srv

; Registros adicionais para serviÃ§os
srv     IN A 192.168.0.11
db      IN A 192.168.0.12

; Registro TXT para verificaÃ§Ãµes e polÃ­ticas
@       IN TXT "v=spf1 include:_spf.google.com ~all"
```

**ValidaÃ§Ã£o do arquivo de zona:**
```bash
sudo named-checkzone particula.local /etc/bind/db.particula.local
```

### Arquivo de Zona Reversa

```bash
sudo vi /etc/bind/db.0.168.192
```

```
$TTL 3D
$ORIGIN 0.168.192.IN-ADDR.ARPA.

@ IN SOA ns1.particula.local. root.particula.local. (
    2024061401  ; Serial
    8H          ; Refresh
    2H          ; Retry
    4W          ; Expire
    1D          ; Negative Cache TTL
)

; Registros NS
    IN NS ns1.particula.local.
    IN NS ns2.particula.local.

; Registros PTR - ResoluÃ§Ã£o reversa (IP para hostname)
5   IN PTR ns1.particula.local.
6   IN PTR ns2.particula.local.
7   IN PTR mail1.particula.local.
8   IN PTR mail2.particula.local.
9   IN PTR ftp.particula.local.
10  IN PTR ftp.particula.local.
11  IN PTR srv.particula.local.
12  IN PTR db.particula.local.
```

**ValidaÃ§Ã£o da zona reversa:**
```bash
sudo named-checkzone 0.168.192.in-addr.arpa /etc/bind/db.0.168.192
```

### AplicaÃ§Ã£o das ConfiguraÃ§Ãµes

```bash
# Recarregar configuraÃ§Ãµes sem reiniciar o serviÃ§o
sudo rndc reload

# Verificar status
sudo systemctl status bind9
```

### ConfiguraÃ§Ã£o do Resolv.conf

```bash
sudo vi /etc/resolv.conf
```

```
domain particula.local
search particula.local
nameserver 192.168.0.5
nameserver 192.168.0.6
```

---

## ğŸ”„ ConfiguraÃ§Ã£o do Servidor SecundÃ¡rio (ns2)

### ConfiguraÃ§Ã£o de OpÃ§Ãµes

```bash
sudo cp /etc/bind/named.conf.options{,.origin}
sudo vi /etc/bind/named.conf.options
```

```
acl rede {
    192.168.0.0/24;
};

options {
    directory "/var/cache/bind";
    version none;
    listen-on port 53 { localhost; rede; };
    
    // Desabilita transferÃªncia de zona nÃ£o autorizada
    allow-transfer { rede; };
    allow-query { rede; };
    allow-recursion { localhost; rede; };
    
    // ConfiguraÃ§Ãµes especÃ­ficas para servidor secundÃ¡rio
    recursion yes;
    notify no;  // SecundÃ¡rio nÃ£o notifica outros servidores
};
```

### ConfiguraÃ§Ã£o de Zonas SecundÃ¡rias

```bash
sudo cp /etc/bind/named.conf.local{,.origin}
sudo vi /etc/bind/named.conf.local
```

```
// Zona direta como secundÃ¡ria
zone "particula.local" IN {
    type slave;
    file "db.particula.local";
    masters { 192.168.0.5; };
    allow-notify { 192.168.0.5; };
    
    // ConfiguraÃ§Ãµes adicionais para servidor secundÃ¡rio
    max-transfer-time-in 60;
};

// Zona reversa como secundÃ¡ria
zone "0.168.192.in-addr.arpa" IN {
    type slave;
    file "db.0.168.192";
    masters { 192.168.0.5; };
    allow-notify { 192.168.0.5; };
    max-transfer-time-in 60;
};
```

**ValidaÃ§Ã£o e aplicaÃ§Ã£o:**
```bash
sudo named-checkconf /etc/bind/named.conf.local
sudo systemctl restart bind9.service
```

### ConfiguraÃ§Ã£o do Resolv.conf (SecundÃ¡rio)

```bash
sudo vi /etc/resolv.conf
```

```
domain particula.local
search particula.local
nameserver 192.168.0.5
nameserver 192.168.0.6
```

---

## ğŸ“¡ TransferÃªncia de Zona

### Conceitos de TransferÃªncia

A **transferÃªncia de zona** Ã© o processo de sincronizaÃ§Ã£o dos dados entre servidores primÃ¡rio e secundÃ¡rio:

#### AXFR (Full Zone Transfer)
- TransferÃªncia completa de todos os registros da zona
- Utilizada na primeira sincronizaÃ§Ã£o ou quando hÃ¡ muitas alteraÃ§Ãµes
- Consome mais largura de banda

#### IXFR (Incremental Zone Transfer) 
- TransferÃªncia apenas das diferenÃ§as entre versÃµes
- Mais eficiente para pequenas alteraÃ§Ãµes
- Baseada no nÃºmero serial da zona

### Monitoramento da TransferÃªncia

```bash
# Visualizar logs de transferÃªncia
sudo journalctl -u named | grep -i transfer

# Exemplo de log de transferÃªncia bem-sucedida:
# ns1 named[622]: zone particula.local/IN: sending notifies (serial 2024061401)
# ns1 named[622]: client 192.168.0.6#51219: transfer of 'particula.local/IN': AXFR-style IXFR started
# ns1 named[622]: client 192.168.0.6#51219: transfer of 'particula.local/IN': AXFR-style IXFR ended
```

---

## ğŸ” Ferramentas de Consulta DNS

### NSLOOKUP

```bash
# Consulta bÃ¡sica de registro A
nslookup particula.local

# Consulta reversa
nslookup 192.168.0.5

# Consulta de host especÃ­fico
nslookup web1.particula.local

# Consulta de registros NS
nslookup -query=ns particula.local

# Modo debug
nslookup -debug particula.local

# Consulta interativa
nslookup
> set type=MX
> particula.local
> exit
```

### DIG (Recomendado)

```bash
# Consulta de registro A
dig particula.local A

# Consulta de registro MX
dig particula.local MX

# Consulta de registro SOA
dig particula.local SOA

# Consulta de TTL
dig particula.local TTL

# Todos os registros (formato limpo)
dig particula.local ANY +noall +answer

# Consulta com servidor especÃ­fico
dig @192.168.0.5 particula.local

# Consulta reversa
dig -x 192.168.0.5

# Trace completo da consulta
dig +trace particula.local

# Consulta curta (apenas resposta)
dig +short particula.local A

# Consulta com estatÃ­sticas
dig +stats particula.local
```

### HOST

```bash
# Sintaxe bÃ¡sica
host [OPCAO] [DOMINIO]

# OpÃ§Ãµes principais:
# -a - todos os protocolos
# -d - modo detalhado  
# -l [IP_NS] - transferÃªncia de zona
# -t [REGISTRO] - tipo especÃ­fico (any, mx, ns, axfr, cname)
# -C - exibe registros SOA

# Exemplos prÃ¡ticos:
host ns1.particula.local
host www.particula.local  
host 192.168.0.5
host -t SOA particula.local
host -t MX particula.local
host -a particula.local
```

---

## ğŸ“Š Monitoramento com TCPDUMP

### Captura de Consultas DNS

```bash
# Servidor ns1 - Capturar pacotes UDP porta 53
sudo tcpdump -i ens33 udp port 53 -w ns1.pcap

# Ler pacotes capturados
sudo tcpdump -n -t -r ns1.pcap port 53
```

**Exemplo de saÃ­da:**
```
# Host 192.168.0.42 consulta particula.local no NS 192.168.0.6
IP 192.168.0.42.59361 > 192.168.0.6.53: A? particula.local.

# NS 192.168.0.6 responde com IP da zona
IP 192.168.0.6.53 > 192.168.0.42.59361: A 192.168.0.6
```

### Monitoramento de TransferÃªncia de Zona

```bash
# Capturar transferÃªncias TCP (porta 53)
sudo tcpdump -i ens33 tcp port 53 -w transferencia.pcap

# Analisar transferÃªncia AXFR
sudo tcpdump -n -t -r transferencia.pcap port 53 | grep AXFR
```

**Processo de transferÃªncia observado:**
1. Servidor secundÃ¡rio conecta via TCP
2. Solicita AXFR da zona
3. PrimÃ¡rio transfere todos os registros
4. ConexÃ£o Ã© encerrada

---

## ğŸ› ï¸ UtilitÃ¡rios de AdministraÃ§Ã£o

### RNDC (Remote Name Daemon Control)

```bash
# Comandos principais do rndc:

# Exibir estatÃ­sticas
sudo rndc stats
sudo rndc status

# Recarregar configuraÃ§Ãµes
sudo rndc reload

# Recarregar zona especÃ­fica
sudo rndc reload particula.local

# Parar o BIND
sudo rndc stop

# Parar sem salvar alteraÃ§Ãµes pendentes
sudo rndc halt

# Limpar cache
sudo rndc flush

# Reler apenas configuraÃ§Ãµes (nÃ£o zonas)
sudo rndc reconfig

# Dump do cache
sudo rndc dumpdb

# EstatÃ­sticas detalhadas
sudo rndc recursing
sudo rndc querylog
```

### Comandos de VerificaÃ§Ã£o

```bash
# Verificar sintaxe da configuraÃ§Ã£o principal
sudo named-checkconf

# Verificar configuraÃ§Ã£o especÃ­fica
sudo named-checkconf /etc/bind/named.conf.local

# Verificar zona especÃ­fica
sudo named-checkzone particula.local /etc/bind/db.particula.local

# Verificar todas as zonas
sudo named-checkconf -z
```

---

## ğŸ”’ ConfiguraÃ§Ãµes de SeguranÃ§a

### OcultaÃ§Ã£o da VersÃ£o do BIND

```bash
# Testar versÃ£o atual (antes da proteÃ§Ã£o)
dig +short @particula.local version.bind txt chaos
```

**Resultado sem proteÃ§Ã£o:**
```
"9.18.12-0ubuntu0.22.04.1-Ubuntu"
```

**ConfiguraÃ§Ã£o de seguranÃ§a em `/etc/bind/named.conf.options`:**
```
options {
    version none;           // Oculta versÃ£o
    hostname none;          // Oculta hostname
    server-id none;         // Oculta server-id
};
```

**ApÃ³s aplicar configuraÃ§Ã£o:**
```bash
sudo rndc reload
dig +short @particula.local version.bind txt chaos
# Resultado: Nenhuma informaÃ§Ã£o retornada
```

### ConfiguraÃ§Ãµes Adicionais de SeguranÃ§a

```bash
# Adicionar ao named.conf.options:
options {
    // Desabilitar recursÃ£o para consultas externas
    allow-recursion { localhost; rede; };
    
    // Rate limiting contra ataques DDoS
    rate-limit {
        responses-per-second 5;
        window 5;
    };
    
    // Desabilitar transferÃªncia de zona nÃ£o autorizada
    allow-transfer { none; };
    
    // Logging de consultas suspeitas
    querylog yes;
    
    // Desabilitar notificaÃ§Ãµes nÃ£o solicitadas
    notify no;
    
    // ConfiguraÃ§Ãµes de cache seguro
    max-cache-size 256M;
    cleaning-interval 60;
};
```

### Hardening do Sistema

```bash
# Configurar firewall para DNS
sudo ufw allow 53/udp
sudo ufw allow 53/tcp

# Monitoramento de logs suspeitos
sudo tail -f /var/log/syslog | grep named

# Verificar processos do BIND
ps aux | grep named

# Monitorar conexÃµes ativas
sudo netstat -tulnp | grep :53
```

---

## ğŸš¨ SoluÃ§Ã£o de Problemas Comuns

### Problemas de ConfiguraÃ§Ã£o

```bash
# 1. Verificar sintaxe dos arquivos
sudo named-checkconf
sudo named-checkzone particula.local /etc/bind/db.particula.local

# 2. Verificar logs de erro
sudo journalctl -u named -f

# 3. Testar conectividade
dig @localhost particula.local
dig @192.168.0.5 particula.local

# 4. Verificar permissÃµes
ls -la /etc/bind/
sudo chown -R bind:bind /etc/bind/

# 5. Verificar portas em uso
sudo netstat -tulnp | grep :53
```

### Problemas de TransferÃªncia de Zona

```bash
# 1. Verificar configuraÃ§Ã£o de allow-transfer
grep -r "allow-transfer" /etc/bind/

# 2. Testar transferÃªncia manual
dig @192.168.0.5 particula.local AXFR

# 3. Verificar logs no servidor primÃ¡rio
sudo journalctl -u named | grep -i transfer

# 4. Verificar serial numbers
dig @192.168.0.5 particula.local SOA
dig @192.168.0.6 particula.local SOA
```

### Comandos de DiagnÃ³stico

```bash
# Status completo do serviÃ§o
sudo systemctl status bind9 -l

# Teste de resoluÃ§Ã£o local
nslookup particula.local localhost

# Verificar cache
sudo rndc dumpdb
sudo cat /var/cache/bind/named_dump.db

# Monitor de consultas em tempo real
sudo tcpdump -i any port 53 -n
```

---

## ğŸ“‹ Checklist de ImplementaÃ§Ã£o

### Servidor PrimÃ¡rio
- [ ] Instalar BIND9 e ferramentas
- [ ] Configurar named.conf.options
- [ ] Configurar named.conf.local
- [ ] Criar arquivo de zona direta
- [ ] Criar arquivo de zona reversa
- [ ] Configurar logging
- [ ] Aplicar configuraÃ§Ãµes de seguranÃ§a
- [ ] Testar resoluÃ§Ã£o local

### Servidor SecundÃ¡rio  
- [ ] Instalar BIND9 e ferramentas
- [ ] Configurar como servidor slave
- [ ] Configurar transferÃªncia de zona
- [ ] Verificar sincronizaÃ§Ã£o
- [ ] Testar resoluÃ§Ã£o local

### Testes Finais
- [ ] Consultas DNS funcionais
- [ ] TransferÃªncia de zona operacional
- [ ] Logs sem erros
- [ ] SeguranÃ§a implementada
- [ ] DocumentaÃ§Ã£o atualizada

---

## ğŸ“š ReferÃªncias e Recursos Adicionais

- [ISC BIND 9 Administrator Reference Manual](https://bind9.readthedocs.io/)
- [RFC 1035 - Domain Names Implementation](https://tools.ietf.org/html/rfc1035)
- [DNS Security Extensions (DNSSEC)](https://tools.ietf.org/html/rfc4033)
- [BIND 9 Security Considerations](https://kb.isc.org/docs/bind-9-security-considerations)

> **ğŸ’¡ ManutenÃ§Ã£o:** Lembre-se sempre de incrementar o nÃºmero serial ao fazer alteraÃ§Ãµes nas zonas e manter backups regulares das configuraÃ§Ãµes.