#: Title : Nginx
#: Author : "Caio Abreu Ferreira" <abreuferr_gmail.com>
#: Description : 208.4 Implementing Nginx as a web server and a reverse proxy
#: Options : Weight: 2

Description: Candidates should be able to install and configure a reverse proxy 
server, Nginx. Basic configuration of Nginx as a HTTP server is included.

Key Knowledge Areas:
- Nginx
- Reverse Proxy
- Basic Web Server

Terms and Utilities:
- /etc/nginx/
- nginx

#
# INICIO
#

$ sudo apt-get update
$ sudo apt-get upgrade

$ wget http://nginx.org/keys/nginx_signing.key ; obter a chave de criptografia
$ sudo sudo apt-key add nginx_signing.key ; adicionar a chave de criptografia
$ sudo vim /etc/apt/sources.list.d/nginx-stable.list ; adicionando o repositorio do nginx
	deb http://nginx.org/packages/debian/ stretch nginx

$ sudo apt-get install nginx -y -d ; instalacao do nginx

$ sudo systemctl start nginx ; inicializacao do servico nginx
$ sudo systemctl enable nginx ; habilitar o nginx no boot

$ sudo systemctl status nginx ; status do servico do nginx

#
# BASICO
#

$ sudo mkdir -p /var/www/particula.local/html ; diretorio a onde sera armazenado o codigo do site
$ sudo vi /var/www/particula.local/html/index.html ; pagina para teste
	<!DOCTYPE html>
	<html>
		<head>
			<title>Nginx - particula.local</title>
		</head>
		<body>
			<h1>Welcome to particula.local</h1>
			<p>Particula.local Test Page running on NGINX Web Server</p>
		</body>
	</html>

$ sudo vi /etc/nginx/sites-available/particula.local ; arquivo de configuracao do site particula.local
	server {
		# geral
		listen 80;
		root /var/www/particula.local/html;
		index index.html;
		server_name www.particula.local particula.local;

		# log files
		access_log  /var/log/nginx/particula.local_access.log;
		error_log   /var/log/nginx/particula.local_error.lg;
	}

$ sudo ln -s /etc/nginx/sites-available/particula.local /etc/nginx/sites-enabled/ ; ativando o dominio virtual

$ sudo nginx -t ; testar os arquivos de configuracao

$ sudo systemctl restart nginx ; reinicializar o servico do nginx

#
# SSL
#

$ sudo openssl req -x509 -days 703 -sha256 -newkey rsa:2048 -nodes -keyout /etc/ssl/private/particula_local.key -out /etc/ssl/certs/particula_local-cert.pem

$ sudo vi /etc/nginx/sites-available/particula.local ; configuracao do nginx para trabalhar com certificado ssl
	server {
		# geral
		listen 80;
		root /var/www/particula.local/html;
		index index.html;
		server_name www.particula.local particula.local;

		# redirecionar HTTP to HTTPS
		return 301 https://$host$request_uri;

		# log files
		access_log  /var/log/nginx/particula.local_access.log;
		error_log   /var/log/nginx/particula.local_error.lg;
	}

	server {
		# geral ssl
	        listen 443 ssl;
	        root /var/www/particula.local/html;
	        index index.html;
	        server_name www.particula.local particula.local;

		# log files
		access_log  /var/log/nginx/particula.local_access.log;
		error_log   /var/log/nginx/particula.local_error.lg;

		# certificado ssl
	        ssl_certificate /etc/ssl/certs/particula_local-cert.pem;
	        ssl_certificate_key /etc/ssl/private/particula_local.key;
	}

$ sudo nginx -t ; testar os arquivos de configuracao

$ sudo systemctl restart nginx ; reinicializar o servico do nginx

#
# PROXY REVERSO (SEM SSL)
# (servidor nginx - 192.168.0.9)
#

$ sudo vi /etc/nginx/sites-available/particula.local ; configuracao do dominio particula.local
	server {
		# geral
        	listen 80;
	        server_name www.particula.local;

	        # log files
	        access_log  /var/log/nginx/particula.local_access.log;
        	error_log   /var/log/nginx/particula.local_error.lg;

		# proxy reverso
	        location / {
        	        proxy_pass_header Authorization;
	                proxy_pass http://192.168.0.9;
        	        proxy_set_header Host $host;
                	proxy_set_header X-Real-IP $remote_addr;
	                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        	        proxy_set_header X-Forwarded-Proto $scheme;
	        }
	}

$ sudo nginx -t

$ sudo ln -s /etc/nginx/sites-available/particula.local /etc/nginx/sites-enabled

$ sudo systemctl restart nginx

#
# PROXY REVERSO (COM SSL)
# (servidor nginx - 192.168.0.9)
#

$ sudo vi /etc/nginx/sites-available/particula.local
	# http
	server {
		$ geral
		listen 80;

		# redirecionamento do http para o https
		return 301 https://$host$request_uri;
	}

	# https
	server {
		# geral ssl
        	listen 443;
	        server_name particula.local www.particula.local;

		# ssl
		ssl_certificate /etc/nginx/ssl/cert.crt;
		ssl_certificate_key /etc/nginx/ssl/cert.key;
		ssl on;
		ssl_session_cache builtin:1000 shared:SSL:10m;
		ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
		ssl_ciphers HIGH:!aNULL:!eNULL:!EXPORT:!CAMELLIA:!DES:!MD5:!PSK:!RC4;
		ssl_prefer_server_ciphers on;

	        # log files
	        access_log  /var/log/nginx/particula.local_access.log;
        	error_log   /var/log/nginx/particula.local_error.lg;

		# proxy reverso
	        location / {
        	        proxy_pass_header Host $host;
                	proxy_set_header X-Real-IP $remote_addr;
	                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        	        proxy_set_header X-Forwarded-Proto $scheme;
	                proxy_pass http://192.168.0.9;
			proxy_redirect https://192.168.0.9;
	        }
	}

$ sudo nginx -t ; testa o arquivo de configuracao

$ sudo ln -s /etc/nginx/sites-available/particula.local /etc/nginx/sites-enabled ; ativa o site

$ sudo systemctl restart nginx ; reinicializa o servico de nginx
