#: Title : NFS Server Configuration
#: Author : "Caio Abreu Ferreira" <abreuferr_gmail.com>
#: Description : NFS Server Configuration
#: Options : Weight: 3

Description: Candidates should be able to export filesystems using 
NFS. This objective includes access restrictions, mounting an NFS 
filesystem on a client and securing NFS.

Key Knowledge Areas:
- NFS version 3 configuration files
- NFS tools and utilities
- Access restrictions to certain hosts and/or subnets
- Mount options on server and client
- TCP Wrappers
- Awareness of NFSv4

Terms and Utilities:
- /etc/exports
- exportfs
- showmount
- nfsstat
- /proc/mounts
- /etc/fstab
- rpcinfo
- mountd
- portmapper

#
# TEORIA
#

# server - 192.168.0.11 
# client - 192.168.0.0/24

#
# INSTALACAO - SERVER
#

# atualizar o do sistema operacional
$ sudo apt-get update && sudo apt-get upgrade

# instalacao dos componentes do NFS Server
$ sudo apt-get install nfs-kernel-server nfs-common -y -d

#
# CONFIGURACAO - SERVER
#

# diretorio que sera exportado
$ sudo mkdir -p /mnt/nfs

# permissao do diretorio que sera exportado
$ sudo chown root:users -R /mnt/nfs
$ sudo chmod 775 -R /mnt/nfs

# editar o arquivos /etc/export para exportar os
# diretorios.
$ sudo vi /etc/exports ; configuracao do nfs server
	# rw - permite a leitura e escrita no diretorio
	# ro - permite somente a opcao de leitura, opcao de escrita fica desabilidatea
	# sync - escreve e le os dados de forma sincronizada
	# async - escreve e le os dados de forma asincrona. Aumenta a velocidade mas pode causar a corrupcao dos dados
	# subtree_check - faz a checagem de toda a árvore de subdiretório que foi exportada e não somente do diretório principal.
	# root_squash - o usuario root do cliente NAO possui os mesmo privilegios do servidor nfs (cliente>root ; server>nobody)
	# no_root_squash - o usuario root do cliente possui os mesmo privilegios do servidor nfs (cliente>root ; server>root).
	# lock - trava de acesso a arquivo, impedindo assim que dois ou mais clientes ao acessar o mesmo arquivo ao mesmo tempo.
	# wdelay - atraso no processo de escrita se por acaso outro processo estiver escrevendo no disco rigido
	#
	# exemplo
	# directory hostname(options)
        # /mnt/nfs  192.168.10.0/24(rw,sync,no_root_squash,no_subtree_check)

# exportar todos os diretorios listados no arquivo 
# /etc/exports.
$ sudo exportfs -a
	# [none] - exibi quais sao os diretorios que estao exportados (ativos).
	# -a - export diretorios presentes no arquivo /etc/exports.
	# -ar - re-export diretorios presentes no arquivo /etc/exports.
	# -au - unexport diretorio presentes no arquivo /etc/exports.
	# -v - modo verbose, com mais detalhes.

#
# INSTALACAO - CLIENT
#

# atualizar o do sistema operacional
$ sudo apt-get update && sudo apt-get upgrade

# instalacao dos componentes do NFS Server
$ sudo apt-get install nfs-common -y -d

#
# CONFIGURACAO - CLIENT
#

# diretorio que sera exportado
$ sudo mkdir -p /mnt/nfs

# permissao do diretorio que sera exportado
$ sudo chown root:users -R /mnt/nfs
$ sudo chmod 775 -R /mnt/nfs

# montando o diretorio exportado pelo servidor NFS
# de forma manual.
# caso nao saiba o nome do diretorio do servidor que
# possa ser exportado, basta executar o comando 
# "showmount -e 192.168.0.11".
$ sudo mount -t nfs 192.168.0.11:/mnt/nfs /mnt/nfs

# para verificar se realmente o diretorio exportado
# no servidor foi montado na estacao, basta executar
# o comando.
$ sudo df -h

# caso o computador seja reinicializado, o diretorio
# exportado pelo servidor nfs sera montador de forma
# automatica.
$ cat /etc/fstab
	192.168.0.11:/mnt/nfs /mnt/nfs nfs auto,nofail,noatime,nolock,intr,tcp,actimeo=1800 0 0

#
# INFORMACAO
#

# SERVER
# obter informacao dos diretorios que estao montados.
$ sudo cat /proc/fs/nfs/exports

# CLIENT
$ sudo showmount [opcao]
	# -e [IP_SERVER]- exibe uma lista dos diretorios expostados
	# -a - exibe o nome ou ip das estacoes que importaram os direorios
	# -d - lista os direotios montados nos clientes
	# -e - exibe uma lista dos diretorios expostados

# SERVER/CLIENT
# exibir estatistica
$ sudo nfsstat [OPCAO]
	-m - exibir informacao do lado do cliente
	-c - exibir informacao do lado do cliente
	-s - exibir informacao do lado do servidor
	-r - exibir informacao do lado do servidor/cliente

# CLIENT
$ sudo cat /proc/mounts

# CLIENT
# obter informacoes atraves do aplicativo rpcinfo.
$ sudo rpcinfo [OPCAO]
	-p - exibe as portas que estao sendo mapeadas.
	-s - exibe informacoes, como por exemplo, versao e servico.
	-m - exibir dados estatisticos.
