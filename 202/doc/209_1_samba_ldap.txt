#: Title : SAMBA Server Configuration
#: Author : "Caio Abreu Ferreira" <abreuferr_gmail.com>
#: Description : samba server configuration - ldap and centos
#: Options : Weight 5

Description: Candidates should be able to set up a Samba server 
for various clients. This objective includes setting up Samba 
as a standalone server as well as integrating Samba as a member 
in an Active Directory. Furthermore, the configuration of simple 
CIFS and printer shares is covered. Also covered is a configuring 
a Linux client to use a Samba server. Troubleshooting installations 
is also tested.

Key Knowledge Areas:
- Samba 4 documentation
- Samba 4 configuration files
- Samba 4 tools and utilities and daemons
- Mounting CIFS shares on Linux
- Mapping Windows user names to Linux user names
- User-Level, Share-Level and AD security

Terms and Utilities:
- smbd, nmbd, winbindd
- smbcontrol, smbstatus, testparm, smbpasswd, nmblookup
- samba-tool
- net
- smbclient
- mount.cifs
- /etc/samba/
- /var/log/samba/

#
# Observacao
#

# O servidor LDAP j√° foi previamente instalado e
# configurado em outro texto. Ele esta sendo utilizado
# junto com o Squid, Apache e Nginx. Desta forma, nao
# sera descrito neste texto, como fazer a instalacao e
# configuracao inicial do LDAP.

#
# Samba (servidor)
#

# configurando o LDAP Authentication
$ sudo apt-get install libnss-ldap
	ldap://192.168.0.13
	dc=particula,dc=local
	3
	Yes
	No
	cn=admin,dc=particula,dc=local
	[SENHA]

# Configuracao do LDAP profile
$ sudo pam-auth-update --force
	marcar todas as opcoes

#
# LDAP (servidor)
#

# o arquivo samba.ldif foi copiado do servidor
# Samba para o servidor LDAP.
$ scp /usr/share/doc/samba/examples/LDAP/samba.ldif.gz cosmo@192.168.0.13:/etc/ldap/schema

# importando o arquivo samba.ldif
$ sudo gzip -d /etc/ldap/schema/samba.ldif.gz
$ sudo ldapadd -Y EXTERNAL -H ldapi:// -f /etc/ldap/schema/samba.ldif.gz

# indice
$ cat samba_indices.ldif
	dn: olcDatabase={1}hdb,cn=config
	changetype: modify
	replace: olcDbIndex
	olcDbIndex: objectClass eq
	olcDbIndex: uidNumber,gidNumber eq
	olcDbIndex: loginShell eq
	olcDbIndex: uid,cn eq,sub
	olcDbIndex: memberUid eq,sub
	olcDbIndex: member,uniqueMember eq
	olcDbIndex: sambaSID eq
	olcDbIndex: sambaPrimaryGroupSID eq
	olcDbIndex: sambaGroupType eq
	olcDbIndex: sambaSIDList eq
	olcDbIndex: sambaDomainName eq
olcDbIndex: default sub,eq
$ sudo ldapmodify -Q -Y EXTERNAL -H ldapi:/// -f samba_indices.ldif
$ sudo ldapi:/// -b cn=config olcDatabase={1}hdb olcDbIndex

# slapd.conf
$ sudo vi /etc/ldap/slapd.conf
	include     /etc/openldap/schema/core.schema
	include     /etc/openldap/schema/cosine.schema
	include     /etc/openldap/schema/inetorgperson.schema
	include     /etc/openldap/schema/nis.schema
	include     /etc/openldap/schema/samba.schema
 
	loglevel    -1
	pidfile     /var/run/slapd.pid
	argsfile    /var/run/slapd.args
 
	database    hdb

	suffix      "dc=particula,dc=local"
	rootdn      "cn=admin,dc=particula,dc=local"
 
	rootpw      {SSHA}kCuJt72QLJ2O06nFUvdre97sHT0AxlH/
 
	index objectClass           eq
	index cn                    pres,sub,eq
	index sn                    pres,sub,eq
	index uid                   pres,sub,eq
	index displayName           pres,sub,eq
	index uidNumber             eq
	index gidNumber             eq
	index memberUID             eq
	index sambaSID              eq
	index sambaPrimaryGroupSID  eq
	index sambaDomainName       eq
	index default               sub
 
	sambaNTPassword,sambaLMPassword,sambaPwdLastSet,sambaPwdMustChange
	      by dn="uid=samba,ou=users,dc=particula,dc=local" write
	      by self write
	      by anonymous auth
	      by * none
	access to attrs=objectClass,entry,gecos,homeDirectory,uid,uidNumber,gidNumber,cn,
	memberUid
	      by dn="uid=samba,ou=users,dc=particula,dc=local" write
	      by * read
	access to attrs=description,telephoneNumber
	      by dn="uid=samba,ou=users,dc=particula,dc=local" write
	      by self write
	      by * read
	some unix commands to work) access to attrs=cn,sambaLMPassword,sambaNTPassword,
	sambaPwdLastSet,sambaLogonTime,sambaLogoffTime,sambaKickoffTime,sambaPwdCanChange,
	sambaPwdMustChange,sambaAcctFlags,displayName,sambaHomePath,sambaHomeDrive,
	sambaLogonScript,sambaProfilePath,description,sambaUserWorkstations,sambaPrimaryGroupSID,
	sambaDomainName,sambaSID,sambaGroupType,sambaNextRid,sambaNextGroupRid,sambaNextUserRid,
	sambaAlgorithmicRidBase,sambaLogonScript,loginShell
	      by dn="uid=samba,ou=users,dc=particula,dc=local" write
	      by self read
	      by * none
	access to dn.base="dc=particula,dc=local"
	      by dn="uid=samba,ou=users,dc=particula,dc=local" write
	      by * none
	access to dn="ou=Users,dc=particula,dc=local"
	      by dn="uid=samba,ou=users,dc=particula,dc=local" write
	      by * none
	access to dn="ou=Groups,dc=particula,dc=local"
	      by dn="uid=samba,ou=users,dc=particula,dc=local" write
	      by * none
	access to dn="ou=Computers,dc=particula,dc=local"
	      by dn="uid=samba,ou=users,dc=particula,dc=local" write
	      by * none
	access to *
	      by self read
	      by * none


#
# Samba (servidor)
#

# atualizacao
$ sudo apt-get update && sudo apt-get upgrade

# instalacao do samba
$ sudo yum -y install samba smbldap-tools

# configurando o smbldap-tools
$ sudo cp /usr/share/doc/smbldap-tools/examples/smbldap.conf.gz /etc/smbldap-tools/
$ sudo cp /usr/share/doc/smbldap-tools/examples/smbldap_bind.conf /etc/smbldap-tools/
$ sudo gzip -d /etc/smbldap-tools/smbldap.conf.gz

# obtendo o SID do dominio
$ sudo net getlocalsid
	SID for domain SAMBA is: S-1-5-21-3442726937-1468842005-207868225

# configurar o smbldap-tools
$ sudo vi /etc/smbldap-tools/smbldap.conf
	(ALTERAR AS OPCOES NECESSARIAS)
$ sudo vi /etc/smbldap-tools/smbldap_bind.conf
	(ALTERAR AS OPCOES NECESSARIAS)

# popular os dados na base de dados do LDAP.
$ sudo smbldap-populate

# configuracao do ldap no cliente
$ sudo apt-get install libnss-ldap libpam-ldap nscd
$ sudo vi /etc/ldap/ldap.conf
	BASE    dc=particula,dc=local
	URI     ldap://192.168.0.13
$ sudo vi /etc/nsswitch.conf
	passwd:         compat ldap
	group:          compat ldap
	shadow:         compat ldap
$ sudo systemctl restart nscd
$ sudo vi /etc/pam.d/common-auth
	auth    [success=2 default=ignore]      pam_unix.so nullok_secure try_first_pass
	auth    [success=1 default=ignore]      pam_ldap.so use_first_pass
	[...]
	auth    requisite                       pam_deny.so
	[...]
	auth    required                        pam_permit.so
$ sudo vi /etc/pam.d/common-account
	[...]
	account [success=2 new_authtok_reqd=done default=ignore]        pam_unix.so
	account [success=1 default=ignore]      pam_ldap.so
	[...]
	account requisite                       pam_deny.so
	[...]
	account required                        pam_permit.so
	[...]
$ sudo vi /etc/pam.d/common-password
	[...]
	password        [success=2 default=ignore]      pam_unix.so obscure sha512
	password        [success=1 user_unknown=ignore default=die]     pam_ldap.so use_authtok try_first_pass
	[...]
	password        requisite                       pam_deny.so
	[...]
	password        required                        pam_permit.so
	[...]
$ sudo vi /etc/pam.d/common-session
	session  required	pam_mkhomedir.so
$ sudo vi /etc/pam.d/common-session-noninteractive
	[...]
	session [default=1]    pam_permit.so
	[...]
	session requisite      pam_deny.so
	[...]
	session required       pam_permit.so
	[...]
	session required       pam_unix.so
	session optional       pam_ldap.so
$ sudo systemctl restart nscd

$ sudo getent group

