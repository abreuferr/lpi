#: Title : openldap server configuration
#: Author : "Caio Abreu Ferreira" <abreuferr_gmail.com>
#: Description : openldap server configuration
#: Options : Weight: 4

Description: Candidates should be able to configure a 
basic OpenLDAP server including knowledge of LDIF format 
and essential access controls.

Key Knowledge Areas:
- OpenLDAP
- Directory based configuration
- Access Control
- Distinguished Names
- Changetype Operations
- Schemas and Whitepages
- Directories
- Object IDs, Attributes and Classes

Terms and Utilities:
- slapd
- slapd-config
- LDIF
- slapadd
- slapcat
- slapindex
- /var/lib/ldap/
- loglevel

#
# Instalacao
#

# atualizacao do debian
$ sudo apt-get update && sudo apt-get upgrade

# instalacao do servidor openldap
$ sudo apt-get install slapd ldap-utils ldapscripts db-util -y -d

#
# Configuracao
#

# reconfigurando o pacote slapd
$ sudo dpkg-reconfigure slapd
	Omit OpenLDAP server configuration? <NO>
	DNS Domain Name: particula.local
	Organization name: particula
	Administrator password: <SENHA>
	Confirm password: <SENHA>
	Database backend to use: HDB
	Do you want the database to be removed when slapd is purged? <NO>
	Move old database? <YES>

# visualizacao da estrutura inicial do openldap.
$ sudo slapcat

# backup do arquivo de configuracao
$ sudo cp /etc/ldap/ldap.conf /etc/ldap/ldap.conf.BKP

# configuracao do arquivo ldap.conf
$ sudo vi /etc/ldap/ldap.conf
	BASE    dc=particula,dc=local
	URI     ldap://openldap.particula.local ldap://openldap.particula.local:666

#
# Adicionando uma Organizational Unit
#

$ cat vi users.ldif
	dn: ou=users,dc=particula,dc=local
	objectClass: organizationalUnit
	ou: users
$ sudo ldapadd -D cn=admin,dc=particula,dc=local -W -f users.ldif

#
# Adicionando um Usuario
#

# gerando o hash da senha do usuario admin/rootpw
$ sudo slappasswd -h {SSHA}

$ cat caio.ldif
	dn: cn=caio,ou=users,dc=particula,dc=local
	cn: caio
	sn: ferreira
	objectClass: inetOrgPerson
	userPassword: {SSHA}y6l1JNYj9g8Yy/kP5shePMtkKEt8U5H9
	uid: caio
$ sudo ldapadd -D cn=admin,dc=particula,dc=local -W -f caio.ldif

#
# Adicionando um Grupo
#

$ cat group.ldif
	dn: cn=it,ou=users,dc=particula,dc=local
	cn: it
	objectClass: groupOfNames
	member: cn=caio,ou=users,dc=particula,dc=local
$ sudo ldapadd -D cn=admin,dc=particula,dc=local -W -f group.ldif

#
# Apagando Objeto
#

$ sudo ldapdelete "cn=caio,ou=users,dc=particula,dc=local" -D cn=admin,dc=particula,dc=local -W

#
# Log
#

$ sudo vi /etc/rsyslog.conf
	# Log OpenLDAP messages
	local4.*                  /var/log/ldap.log

$ sudo systemctl restart rsyslog slapd

#
# Backup
#

# comando utilizado para extrair/dump da base de dados do servidor ldap
# para um arquivo ldif;
$ sudo slapcat -v -l backup_ldap.ldif

#
# GERENCIAMENTO GRAFICO - LDAP Account Manager (LAM)
#

# instalacao
$ sudo apt-get install ldap-account-manager -y

# restringir/liberar o acesso
$ sudo vi /etc/apache2/conf-enabled/ldap-account-manager.conf
	# Require all granted
	Require ip 192.168.0.0/24

# reinicializar o apache2
$ sudo systemctl restart apache2

# acessar o aplicativo
http://LDAP_SERVER_IP/lam
