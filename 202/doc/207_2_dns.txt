#: Title : DNS Howto
#: Author : "Caio Abreu Ferreira" <abreuferr_gmail.com>
#: Description : 207.2 Create and maintain DNS zones
#: Options : Weight: 3

Key Knowledge Areas:
- BIND 9 configuration files, terms and utilities
- Utilities to request information from the DNS server
- Layout, content and file location of the BIND zone files
- Various methods to add a new host in the zone files, including reverse zones

Terms and Utilities:
- /var/named/
- zone file syntax
- resource record formats
- named-checkzone
- named-compilezone
- masterfile-format
- dig
- nslookup
- host

# INSTALACAO -  DNS PRIMARIO (NS1) e DNS SECUNDARIO (NS2)
#
$ sudo apt-get install bind9 dnsutils bind9 bind9utils bind9-doc -y -d ; instalacao
$ sudo chown -R bind:bind /etc/bind ; alterando permissao
$ sudo systemctl restart bind9.service ; reinicializando o bind

# CONFIGURACAO DO DNS PRIMARIO (NS1)
#
$ sudo vi /etc/bind/named.conf.local
	// configuracao da zona particula.local
	zone "particula.local" {
		// servidor do tipo master
	        type master;

		// arquivo de configuracao da zona particula.local
	        file "db.particula.local";

		// os dados da configuracao do servidor master serao
		//transferidos para o servidor slave. essa transferencia
		// se chama de transferencia de zona.	
	        allow-transfer { 192.168.0.6; };

		// o servidor master ira notificar o servidor slave de
		// que houve uma alteracao na confiuracao da zona.
    		notify yes;
	};

	// configuracao reversa da zona particula.local
	zone "0.168.192.in-addr.arpa" {
		// servidor do tipo master.
	        type master;

		// arquivo de configuracao da zona particula.local
	        file "db.0.168.192.in-addr.arpa";

		// os dados da zona serao transferidos para o servidor
		// slave.
	    	allow-transfer { 192.168.0.6; };
	};

$ sudo vi /etc/bind/named.conf.options
	// acl para controle de quem requisita resolucao
	acl goodclients {
        	192.168.0.0/24;
	};

	options {
        	// diretorio a onde estao os arquivos de configuracao da
        	// zona particula.local
	        directory "/etc/bind";

	        // quais os hosts ou rede podem fazer requisicao
	        allow-query { goodclients; };
	};

$ sudo vi /etc/bind/db.particula.local
	; Start of Authority (SOA) record
	$TTL 604800`
	@ IN SOA ns1.particula.local. root.particula.local. (
				2010101301;	Serial
				28800;		Refresh
				3600;		Retry
				604800;		Expire
				3600 );		Negative Cache TTL

	; Name Server (NS) records.
				IN NS ns1.particula.local.
				IN NS ns2.particula.local.

	; Mail Exchange (MX) records.
				IN MX 10 srv6.particula.local.

	; Address (A) records. (real-names of machines)
				IN A 192.168.0.5
	ns1                    	IN A 192.168.0.5
	ns2                    	IN A 192.168.0.6
	srv1                  	IN A 192.168.0.7
	srv2                  	IN A 192.168.0.8
	srv3                  	IN A 192.168.0.9
	srv4                  	IN A 192.168.0.10
	srv5                  	IN A 192.168.0.11
	srv6                  	IN A 192.168.0.12

	; Aliases in Canonical Name (CNAME) records...
	www			IN CNAME srv5

$ sudo vi /etc/bind/db.0.168.192.in-addr.arpa (master)
	; Start of Authority (SOA) record
	$TTL   900
	@ IN SOA ns1.particula.local. root.particula.local. (
                                2010101301;     Serial
                                28800;          Refresh
                                3600;           Retry
                                604800;         Expire
                                3600 );         Negative Cache TTL

	; Name Server (NS) records.
				IN NS ns1.particula.local.
				IN NS ns2.particula.local.

	; Addresses point to canonical names (PTR) for reverse lookups
	5                       IN PTR    ns1.particula.local.
	6                       IN PTR    ns2.particula.local.
	7                       IN PTR    srv1.particula.local.
	8                       IN PTR    srv2.particula.local.
	9                       IN PTR    srv3.particula.local.
	10                      IN PTR    srv4.particula.local.

$ sudo named-checkconf ; verificar as configuracoes
$ sudo systemctl restart bind9 ; reinicializando o servico

# CONFIGURACAO DO DNS SECUNDARIO (NS2)
#
$ sudo vi /etc/bind/named.conf.local (slave)
	// configuracao da zona particula.local
	zone "particula.local" {
		// servidor do tipo slave
		type slave;

		// arquivo de configuracao da zona
		file "db.particula.local";

		// endereco do servidor master
		masters { 192.168.0.5; };

		// notificar o servidor master
		allow-notify { 192.168.0.5; };
	};

	// configuracao reversa da zona partiicula.local
	zone "0.168.192.in-addr.arpa" {
		// servidor do tipo slave
		type slave;

		// arquivo de configuracao da zona
		file "db.0.168.192.in-addr.arpa";

		// endereco ip do servidor master
		masters { 192.168.0.5; };
	};

$ sudo vi /etc/bind/named.conf.options
	options {
		// diretorio a onde estao localizados os arquivos
		// da zona particula.local
		directory "/etc/bind";
	};

$ sudo systemctl restart bind9 ; reinicializando o servico

# TROUBLESHOOT
#
$ nslookup particula.local ; "A" record do dominio
$ nslookup 192.168.0.5 ; dominio reverso
$ nslookup web1.particula.local ; informacao sobre um determinado host
$ nslookup -query=ns www.particula.local ; NS record
$ nslookup -debug particula.local ; Debug

$ dig particula.local A ; A record
$ dig particula.local MX ; MX record
$ dig particula.local SOA ; SOA record
$ dig particula.local TTL ; TTL record
$ dig particula.local ANY +noall +answer ; ANY record
