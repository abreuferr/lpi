#: Title : dns howto
#: Author : "Caio Abreu Ferreira" <abreuferr_gmail.com>
#: Description : create and maintain dns zones
#: Options : Weight: 3

Key Knowledge Areas:
- BIND 9 configuration files, terms and utilities
- Utilities to request information from the DNS server
- Layout, content and file location of the BIND zone files
- Various methods to add a new host in the zone files, including reverse zones

Terms and Utilities:
- /var/named/ or /etc/bind/
- zone file syntax
- resource record formats
- named-checkzone
- named-compilezone
- masterfile-format
- dig
- nslookup
- host

#
# INSTALACAO
#
# o processo de atualizacao do SO e instalacao deve
# ser executado tanto no servidor primario, ns1, quanto
# no secundario, ns2.

# atualizacao do debian.
$ sudo apt-get update && sudo apt-get upgrade

# instalacao do bind e alterando permissao.
$ sudo apt-get install bind9 dnsutils bind9 bind9utils bind9-doc -y -d
$ sudo chown -R bind:bind /etc/bind

#
# CONFIGURACAO DO DNS PRIMARIO (NS1)
#

# ajustes no arquivo named.conf.options
$ sudo vi /etc/bind/named.conf.options
	// acl para controle de quem podera fazer requisicao 
	// de resolucao.
	acl goodclients {
		// rede que podera fazer reqisicao de resolucao
		// de nome.
        	192.168.0.0/24;
	};

	options {
        	// diretorio a onde estao os arquivos de 
		// configuracao da zona particula.local
        	directory "/etc/bind";

        	// quais os hosts ou rede podem fazer requisicao
        	allow-query { goodclients; };
	};

# arquivo que contem as entradas das zonas que
# o bind ira gerenciar.
$ sudo vi /etc/bind/named.conf.local
	// configuracao da zona particula.local
	zone "particula.local" {
		// servidor do tipo master
	        type master;

		// arquivo de configuracao da zona particula.local
	        file "db.particula.local";

		// os dados da configuracao do servidor master serao
		//transferidos para o servidor slave. essa transferencia
		// se chama de transferencia de zona.	
	        allow-transfer { 192.168.0.6; };

		// o servidor master ira notificar o servidor slave de
		// que houve uma alteracao na confiuracao da zona.
    		notify yes;
	};

	// configuracao reversa da zona particula.local
	// o arquivo de nome "addr.arpa" indica que eh um
	// arquivo de dns reverso.
	zone "0.168.192.in-addr.arpa" {
		// servidor do tipo master.
	        type master;

		// arquivo de configuracao da zona particula.local
	        file "db.0.168.192.in-addr.arpa";

		// os dados da zona serao transferidos para o servidor
		// slave.
	    	allow-transfer { 192.168.0.6; };
	};

// arquivo de configuracao da zona particula.local.
// Hostname > IP.
$ sudo vi /etc/bind/db.particula.local
	; Start of Authority (SOA) record
	$TTL 604800`
	@ IN SOA ns1.particula.local. root.particula.local. (
		// numero de serie.
		2010101301;	Serial
		// frequencia com que o servidor slave checa a
		// procura de alteracao.
		28800;		Refresh
		// em caso de falha, tempo para nova tentativa.
		3600;		Retry
		// tempo em que a informacao sobre a zona fica
		// invalida.
		604800;		Expire
		// tempo de vida.
		3600 );		Negative Cache TTL

	; registro dos Name Server (NS).
		IN NS ns1.particula.local.
		IN NS ns2.particula.local.

	; registro do Mail Exchange (MX).
		IN MX 10 srv6.particula.local.

	; registro de associacao Hostname e IP Address (A)
		IN A 192.168.0.5
	ns1     IN A 192.168.0.5
	ns2     IN A 192.168.0.6
	srv1    IN A 192.168.0.7
	srv2    IN A 192.168.0.8
	srv3    IN A 192.168.0.9
	srv4    IN A 192.168.0.10
	srv5    IN A 192.168.0.11
	srv6    IN A 192.168.0.12

	; registro do apelido, Canonical Name (CNAME)
	www	IN CNAME srv5

# arquivo de configuracao do dns reverso (IP > Hostname)
$ sudo vi /etc/bind/db.0.168.192.in-addr.arpa (master)
	; Start of Authority (SOA) record
	$TTL   900
	@ IN SOA ns1.particula.local. root.particula.local. (
		// numero de serie.
		2010101301;	Serial
		// frequencia com que o servidor slave checa a
		// procura de alteracao.
		28800;		Refresh
		// em caso de falha, tempo para nova tentativa.
		3600;		Retry
		// tempo em que a informacao sobre a zona fica
		// invalida.
		604800;		Expire
		// tempo de vida.
                3600 );         Negative Cache TTL

	; registro com os servidores Name Servers.
		IN NS ns1.particula.local.
		IN NS ns2.particula.local.

	; registro com as associacoes reversas, IP to Hostname.
	5       IN PTR    ns1.particula.local.
	6       IN PTR    ns2.particula.local.
	7       IN PTR    srv1.particula.local.
	8       IN PTR    srv2.particula.local.
	9       IN PTR    srv3.particula.local.
	10      IN PTR    srv4.particula.local.

# comando utilizado para checar a sintaxe dos
# arquivos de configuracao do Bind.
$ sudo named-checkconf

# reler os arquivos de configuracao do Bind.
$ sudo rndc reload

#
# CONFIGURACAO DO DNS SECUNDARIO (NS2)
#

# arquivos de configuracao do bind
$ sudo vi /etc/bind/named.conf.options
	options {
		// diretorio a onde estao localizados os arquivos
		// da zona particula.local
		directory "/etc/bind";
	};

$ sudo vi /etc/bind/named.conf.local
	// configuracao da zona particula.local
	zone "particula.local" {
		// servidor do tipo slave
		type slave;

		// arquivo de configuracao da zona
		file "db.particula.local";

		// endereco do servidor master
		masters { 192.168.0.5; };

		// notificar o servidor master
		allow-notify { 192.168.0.5; };
	};

	// configuracao reversa da zona particula.local
	zone "0.168.192.in-addr.arpa" {
		// servidor do tipo slave
		type slave;

		// arquivo de configuracao da zona
		file "db.0.168.192.in-addr.arpa";

		// endereco ip do servidor master
		masters { 192.168.0.5; };
	};

# reinicializar o bind.
$ sudo rndc reload

#
# TROUBLESHOOT
#

# utilizacao do aplicativo NSLOOKUP
$ nslookup particula.local ; "A" record do dominio
$ nslookup 192.168.0.5 ; dominio reverso
$ nslookup web1.particula.local ; informacao sobre um determinado host
$ nslookup -query=ns www.particula.local ; NS record
$ nslookup -debug particula.local ; Debug

# utilizacao do aplicativo DIG
$ dig particula.local A ; A record
$ dig particula.local MX ; MX record
$ dig particula.local SOA ; SOA record
$ dig particula.local TTL ; TTL record
$ dig particula.local ANY +noall +answer ; ANY record

# aplicativo HOST
$ host [OPCAO] [DOMINIO]
	-a - todos os protocolos
	-d - modo detalhado
	-l [IP_NS1/IP_NS2] - transferencia de zona
	-t [REGISTRO] - any, mx, ns, axfr, cname - consulta
	-C - exibe registros SOA do dominio

#
# UTILITARIO
#

# aplicativo rndc
$ sudo rndc [OPCAO]
	stats/status - exibe estatistica
	reload - reler os arquivos de configuracao e zona
	stop - parar o bind
	halt - parar o servidor sem salvar pendencias
	flush - apagar todo o cache do servidor
	reconfig - reler o arquivo de configuracao e somente nova zona

