#: Title : openldap server configuration
#: Author : "Caio Abreu Ferreira" <abreuferr_gmail.com>
#: Description : openldap server configuration no centos
#: Options : Weight: 4

Description: Candidates should be able to configure a 
basic OpenLDAP server including knowledge of LDIF format 
and essential access controls.

Key Knowledge Areas:
- OpenLDAP
- Directory based configuration
- Access Control
- Distinguished Names
- Changetype Operations
- Schemas and Whitepages
- Directories
- Object IDs, Attributes and Classes

Terms and Utilities:
- slapd
- slapd-config
- LDIF
- slapadd
- slapcat
- slapindex
- /var/lib/ldap/
- loglevel

#
# Instalacao
#

$ sudo yum install openldap-clients openldap-servers -y

# habilitar o servico slapd.
$ sudo systemctl start slapd
$ sudo systemctl enable slapd
$ sudo systemctl status slapd

#
# Modificando Objetos
#

# modificando os atributos "olcSuffix" e "olcRootDN".
$ vi config_1.ldif
dn: olcDatabase={2}hdb,cn=config
changetype: modify
replace: olcSuffix
olcSuffix: dc=particula,dc=local

dn: olcDatabase={2}hdb,cn=config
changetype: modify
replace: olcRootDN
olcRootDN: cn=admin,dc=particula,dc=local

$ sudo ldapmodify -Y EXTERNAL -H ldapi:/// -f config_1.ldif

# adicionando o atributo "olcRootPW".
$ sudo slappasswd

$ vi config_2.ldif
dn: olcDatabase={2}hdb,cn=config
changeType: modify
add: olcRootPW
olcRootPW: {SSHA}6zHtA20qkTmdLrJSfxo+VV3QLGS7m0CZ

$ sudo ldapmodify -Y EXTERNAL -H ldapi:/// -f config_2.ldif

# Substituir o atributo "olcAccess".

$ vi config_3.ldif
dn: olcDatabase={1}monitor,cn=config
changetype: modify
replace: olcAccess
olcAccess: {0}to * by dn.base="gidNumber=0+uidNumber=0,cn=peercred,cn=external, cn=auth" read by dn.base="cn=admin,dc=particula,dc=local" read by * none

$ sudo ldapmodify -Y EXTERNAL -H ldapi:/// -f config_3.ldif

#
# Adicionar Objetos
#

# Validadando os valores dos novos atributos.
$ sudo ldapsearch -Y EXTERNAL -H ldapi:/// -b cn=config olcDatabase=\*

# testar o arquivo de configuracao.
$ sudo slaptest -u

$ vi particula.ldif
dn: dc=particula,dc=local
objectClass: dcObject
objectClass: organization
dc: particula
o: particula

$ sudo ldapadd -f particula.ldif -D cn=admin,dc=particula,dc=local -W

# Validadando os valores dos novos atributos.
$ sudo ldapsearch -x -b dc=particula,dc=local

#
# Adicionando uma Organizational Unit
#

$ sudo vi users.ldif
dn: ou=users,dc=particula,dc=local
objectClass: organizationalUnit
ou: users

$ sudo ldapadd -f users.ldif -D cn=admin,dc=particula,dc=local -W

#
# Adicionando Schema
#

$ sudo ldapadd -Y EXTERNAL -H ldapi:// -f /etc/openldap/schema/cosine.ldif
$ sudo ldapadd -Y EXTERNAL -H ldapi:// -f /etc/openldap/schema/nis.ldif
$ sudo ldapadd -Y EXTERNAL -H ldapi:// -f /etc/openldap/schema/inetorgperson.ldif

#
# Adicionando um Usuario
#

$ sudo ldappasswd

$ vi caio.ldif
dn: cn=caio,ou=users,dc=particula,dc=local
cn: caio
sn: caio
objectClass: inetOrgPerson
userPassword: {SSHA}6zHtA20qkTmdLrJSfxo+VV3QLGS7m0CZ
uid: arch

$ sudo ldapadd -f caio.ldif -x -D cn=admin,dc=particula,dc=local -W

#
# Adicionando um Grupo
#

$ vi group.ldif
dn: cn=it,ou=users,dc=particula,dc=local
cn: it
objectClass: groupOfNames
member: cn=caio,ou=users,dc=particula,dc=local

$ sudo ldapadd -f group.ldif -x -D cn=admin,dc=particula,dc=local -W

# Validadando os valores dos novos atributos.
$ sudo ldapsearch -x -b "dc=particula,dc=local" "(cn=caio)"

#
# Apagando um Usuario
#

$ sudo ldapdelete "cn=caio,ou=users,dc=particula,dc=local" -D cn=admin,dc=particula,dc=local -W

# firewall
$ sudo firewall-cmd --add-service=ldap
$ sudo firewall-cmd --add-service=ldaps
$ sudo firewall-cmd --permanent --zone=public --add-service=ldap
$ sudo firewall-cmd --permanent --zone=public --add-service=ldaps
