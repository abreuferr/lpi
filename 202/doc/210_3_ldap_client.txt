#: Title : LDAP client usage
#: Author : "Caio Abreu Ferreira" <abreuferr_gmail.com>
#: Description : LDAP client usage
#: Options : Weight: 2

Description: Candidates should be able to perform queries 
and updates to an LDAP server. Also included is importing 
and adding items, as well as adding and managing users.

Key Knowledge Areas:

LDAP utilities for data management and queries
Change user passwords
Querying the LDAP directory
Terms and Utilities:

ldapsearch
ldappasswd
ldapadd
ldapdelete

#
# INSTALACAO
#

# atualizacao do debian
$ sudo apt-get update && sudo apt-get upgrade

# instalacao cliente ldap
$ sudo apt-get install libnss-ldap libpam-ldapnscd ldap-utils ldapscripts -y -d

#
# CONFIGURACAO
#

# backup do arquivo de configuracao
$ sudo cp /etc/ldap/ldap.conf /etc/ldap/ldap.conf.BKP

# configuracao inicial do cliente ldap.
$ sudo vi /etc/ldap/ldap.conf
	BASE    dc=particula,dc=local
	URI     ldap://openldap.particula.local ldap://openldap.particula.local:666

#
# LDAPSEARCH
#

# busca de registros dentro da base de dados do openldap.
$ ldapsearch -D "cn=admin,dc=particula,dc=local" -W '(objectclass=*)'

#
# LDAPADD
#

# arquivo LDIF.
$ cat base_ou.ldif
	# people
	dn: ou=people,dc=particula,dc=local
	ou: People
	objectClass: top
	objectClass: organizationalUnit

	# group
	dn: ou=group,dc=particula,dc=local
	ou: Group
	objectClass: top
	objectClass: organizationalUnit

# comando utilizado para adicionar as OUs atraves do arquivo LDIF.
$ ldapadd -D "cn=admin,dc=particula,dc=local" -W -f base.ldif

# arquivo LDIF.
# o conteudo do campo userPassword foi retirado arquivo /etc/shadow
$ cat user_cosmo.ldif
	dn: uid=cosmo,ou=people,dc=particula,dc=local
	objectClass: top
	objectClass: person
	objectClass: organizationalPerson
	objectClass: inetOrgPerson
	objectClass: posixAccount
	objectClass: shadowAccount
	uid: cosmo
	cn: Cosmo Comics
	sn: Cosmo
	givenName: Comics
	title: Big Boss
	telephoneNumber: +0 000 000 0000
	mobile: +0 000 000 0000
	postalAddress: avenida paulista 2001
	userPassword: {CRYPT}$6$RsOxHWv/$8ELKsp8BuTx1GzXWWMfXgvA.RJcdFpKHY3tEfes1gV/wtIu2.Wumh592bZlrEq/hdDCr5aAJvXXYWCiydH3s.1:17968
	labeledURI: https://www.particula.org/
	loginShell: /bin/bash
	uidNumber: 1000
	gidNumber: 1000
	homeDirectory: /home/cosmo/
	description: cosmo comics - big boss

# comando utilizado para adicionar um registro no servidor ldap atraves 
# do arquivo LDIF.
$ ldapadd -D "cn=admin,dc=particula,dc=local" -W -f user_cosmo.ldif

#
# LDAPPASSWD
#

# alterar a senha do usuario.
$ ldappasswd -D cn=admin,dc=particula,dc=local -W -S uid=cosmo,ou=people,dc=particula,dc=local

#
# LDAPDELETE
#

# apagando registro na base de dados do servidor ldap.
$ ldapdelete -D cn=admin,dc=particula,dc=local -W uid=cosmo,ou=people,dc=particula,dc=local

#
# LDAPMODIFY
#

# adicionando um registro.
$ cat add_cosmo.ldif
	dn: uid=cosmo,ou=people,dc=particula,dc=local
	changetype: add
	objectClass: top
	objectClass: person
	objectClass: organizationalPerson
	objectClass: inetOrgPerson
	objectClass: posixAccount
	objectClass: shadowAccount
	uid: cosmo
	cn: Cosmo Comics
	sn: Cosmo
	givenName: Comics
	title: Big Boss
	telephoneNumber: +0 000 000 0000
	mobile: +0 000 000 0000
	postalAddress: avenida paulista 2001
	userPassword: {CRYPT}$6$RsOxHWv/$8ELKsp8BuTx1GzXWWMfXgvA.RJcdFpKHY3tEfes1gV/wtIu2.Wumh592bZlrEq/hdDCr5aAJvXXYWCiydH3s.1:17968
	labeledURI: https://www.particula.org/
	loginShell: /bin/bash
	uidNumber: 1000
	gidNumber: 1000
	homeDirectory: /home/cosmo/
	description: cosmo comics - big boss
$ ldapmodify -D cn=admin,dc=particula,dc=local -W -f add_cosmo.ldif

# apagando um registro.
$ cat delete_cosmo.ldaif
	dn: uid=cosmo,ou=people,dc=particula,dc=local
	changetype: delete
$ ldapmodify -D cn=admin,dc=particula,dc=local -W -f delete_cosmo.ldif

# adicionando um atributo em um registro.
$ cat add_atributo_cosmo.ldaif
	dn: uid=cosmo,ou=people,dc=particula,dc=local
	changetype: modify
	add: facsimileTelephoneNumber
	facsimileTelephoneNumber: +55 51 1234 4321
$ ldapmodify -D cn=admin,dc=particula,dc=local -W -f add_atributo_cosmo.ldif

# modificando um atributo em um registro.
$ cat modify_atributo_cosmo.ldaif
	dn: uid=cosmo,ou=people,dc=particula,dc=local
	changetype: modify
	replace: uidNumber
	uidNumber: 1001
$ ldapmodify -D cn=admin,dc=particula,dc=local -W -f modify_atributo_cosmo.ldif 

# apagando um atributo em um registro.
$ cat delete_atributo_cosmo.ldif
	dn: uid=cosmo,ou=people,dc=particula,dc=local
	changetype: modify
	delete: facsimileTelephoneNumber
$ ldapmodify -D cn=admin,dc=particula,dc=local -W -f delete_atributo_cosmo.ldif
