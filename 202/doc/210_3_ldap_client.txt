#: Title : LDAP client usage
#: Author : "Caio Abreu Ferreira" <abreuferr_gmail.com>
#: Description : LDAP client usage
#: Options : Weight: 2

Description: Candidates should be able to perform queries 
and updates to an LDAP server. Also included is importing 
and adding items, as well as adding and managing users.

Key Knowledge Areas:

LDAP utilities for data management and queries
Change user passwords
Querying the LDAP directory
Terms and Utilities:

ldapsearch
ldappasswd
ldapadd
ldapdelete

#
# INSTALACAO
#

# atualizacao do debian
$ sudo apt-get update && sudo apt-get upgrade

# instalacao cliente ldap
$ sudo apt-get install libnss-ldap libpam-ldapnscd ldap-utils ldapscripts -y -d

#
# CONFIGURACAO
#

# backup do arquivo de configuracao
$ sudo cp /etc/ldap/ldap.conf{,.origin}

# configuracao inicial do cliente ldap.
$ sudo vi /etc/ldap/ldap.conf
	BASE    dc=particula,dc=local
	URI     ldap://openldap.particula.local ldap://openldap.particula.local:666

# .ldaprc local
$ cat /etc/hosts
	127.0.0.1       localhost 			localhost
	192.168.0.13	openldap.particula.local	openldap

$ vi ~/.ldaprc
	BASE    dc=particula,dc=local
	URI     ldap://openldap.particula.local
	BINDDN  cn=admin,dc=particula,dc=local

#
# LDAPSEARCH
#

# busca de registros dentro da base de dados do openldap.
$ ldapsearch -x -W '(objectclass=*)'

#
# LDAPADD
#

# adicionando OU (Organizational Unit)
$ cat base_ou.ldif
	# user
	dn: ou=users,dc=particula,dc=local
	objectClass: organizationalUnit
	ou: users

	# group
	dn: ou=groups,dc=particula,dc=local
	objectClass: organizationalUnit
	ou: groups
$ ldapadd -x -W -f base_ou.ldif

# adicionando USUARIO
$ sudo slappasswd
	{SSHA}RZHmkGBwC2JotUhVIES6QVVwfjmkG6cr
$ cat user.ldif
	dn: uid=cosmo,ou=user,dc=particula,dc=local
	cn: Caio
	sn: Ferreira
	objectClass: inetOrgPerson
	uid: caio
$ ldapadd -x -W -f user.ldif

# adicinando grupo
$ cat group.ldif
	dn: cn=ti, ou=users, dc=particula, dc=local
	cn: ti
	objectClass: groupOfNames
	member: cn=cosmo, ou=users, dc=particula, dc=local
$ ldapadd -D "cn=admin,dc=particula,dc=local" -W -f group.ldif

#
# LDAPSEARCH
#

# busca por um UID
$ sudo ldapsearch -x -W "(uid=cosmo)"

#
# LDAPPASSWD
#

# alterar a senha do usuario.
$ ldappasswd -x -W -S uid=cosmo,ou=people,dc=particula,dc=local

#
# LDAPDELETE
#

# apagando registro na base de dados do servidor ldap.
$ ldapdelete -x -W uid=cosmo,ou=people,dc=particula,dc=local

#
# LDAPMODIFY
#

# adicionando um registro.
$ cat add_cosmo.ldif
	dn: uid=cosmo,ou=people,dc=particula,dc=local
	changetype: add
	objectClass: top
	objectClass: person
	objectClass: organizationalPerson
	objectClass: inetOrgPerson
	objectClass: posixAccount
	objectClass: shadowAccount
	uid: cosmo
	cn: Cosmo Comics
	sn: Cosmo
	givenName: Comics
	title: Big Boss
	telephoneNumber: +0 000 000 0000
	mobile: +0 000 000 0000
	postalAddress: avenida paulista 2001
	userPassword: {CRYPT}$6$RsOxHWv/$8ELKsp8BuTx1GzXWWMfXgvA.RJcdFpKHY3tEfes1gV/wtIu2.Wumh592bZlrEq/hdDCr5aAJvXXYWCiydH3s.1:17968
	labeledURI: https://www.particula.org/
	loginShell: /bin/bash
	uidNumber: 1000
	gidNumber: 1000
	homeDirectory: /home/cosmo/
	description: cosmo comics - big boss
$ ldapmodify -x -W -f add_cosmo.ldif

# apagando um registro.
$ cat delete_cosmo.ldaif
	dn: uid=cosmo,ou=people,dc=particula,dc=local
	changetype: delete
$ ldapmodify -x -W -f delete_cosmo.ldif

# adicionando um atributo em um registro.
$ cat add_atributo_cosmo.ldaif
	dn: uid=cosmo,ou=people,dc=particula,dc=local
	changetype: modify
	add: facsimileTelephoneNumber
	facsimileTelephoneNumber: +55 51 1234 4321
$ ldapmodify -x -W -f add_atributo_cosmo.ldif

# modificando um atributo em um registro.
$ cat modify_atributo_cosmo.ldaif
	dn: uid=cosmo,ou=people,dc=particula,dc=local
	changetype: modify
	replace: uidNumber
	uidNumber: 1001
$ ldapmodify -x -W -f modify_atributo_cosmo.ldif 

# apagando um atributo em um registro.
$ cat delete_atributo_cosmo.ldif
	dn: uid=cosmo,ou=people,dc=particula,dc=local
	changetype: modify
	delete: facsimileTelephoneNumber
$ ldapmodify -x -W -f delete_atributo_cosmo.ldif
