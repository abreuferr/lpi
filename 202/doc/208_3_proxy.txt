#: Title : Implementing a proxy server
#: Author : "Caio Abreu Ferreira" <abreuferr_gmail.com>
#: Description : 208.3 Implementing a proxy server
#: Options : Weight: 2

Description: Candidates should be able to install and configure a 
proxy server, including access policies, authentication and resource 
usage.

Key Knowledge Areas:
- Squid 3.x configuration files, terms and utilities
- Access restriction methods
- Client user authentication methods
- Layout and content of ACL in the Squid configuration files

Terms and Utilities:
- squid.conf
- acl
- http_access

# proxy - 192.168.0.2
#
# no texto abaixo, o proxy foi instalado no mesmo computador do gateway,
# o que NAO eh uma boa escolha pois se por acaso o proxy for comprometido,
# o gateway da rede foi comprometido.

$ sudo apt-get install squid -y -d ; instalacao do proxy Squid

$ sudo mkdir -p /var/cache/squid ; criacao do diretorio de cache do squid
$ sudo chown -R proxy.proxy /var/cache/squid ; alterando permissao

$ sudo mv /etc/squid/squid.conf /etc/squid/squid.conf.BKP ; copia de seguranca do arquivo de configuracao do squid

$ sudo vi /etc/squid/squid.conf ; configuracao basica do squid
	http_port 3128 transparent

	acl localhost src 127.0.0.1/32
	acl localnet src 192.168.0.0/24

	acl SSL_ports port 443
	acl Safe_ports port 80          # http
	acl Safe_ports port 21          # ftp
	acl Safe_ports port 443         # https
	acl Safe_ports port 70          # gopher
	acl Safe_ports port 210         # wais
	acl Safe_ports port 1025-65535  # unregistered ports
	acl Safe_ports port 280         # http-mgmt
	acl Safe_ports port 488         # gss-http
	acl Safe_ports port 591         # filemaker
	acl Safe_ports port 777         # multiling http
	acl CONNECT method CONNECT
	http_access deny !Safe_ports
	http_access deny CONNECT !SSL_ports

	http_access allow localnet
	http_access allow localhost
	http_access deny all

	cache_effective_user proxy
	cache_dir ufs /var/cache/squid 2000 16 256

$ sudo systemctl restart squid.service

$ firewall.squid.sh
	# web proxy squid
	# ens34 - interface interna
	iptables -t nat -A PREROUTING -i ens34 -p tcp --dport 80 -j REDIRECT --to-port 3128
