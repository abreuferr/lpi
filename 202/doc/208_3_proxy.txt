#: Title : implementando um servidor proxy
#: Author : "Caio Abreu Ferreira" <abreuferr_gmail.com>
#: Description : implementando um servidor proxy
#: Options : Weight: 2

Description: Candidates should be able to install and configure a 
proxy server, including access policies, authentication and resource 
usage.

Key Knowledge Areas:
- Squid 3.x configuration files, terms and utilities
- Access restriction methods
- Client user authentication methods
- Layout and content of ACL in the Squid configuration files

Terms and Utilities:
- squid.conf
- acl
- http_access

# proxy - 192.168.0.2
#
# no texto abaixo, o proxy foi instalado no mesmo computador do gateway,
# o que NAO eh uma boa escolha pois se por acaso o proxy for comprometido,
# o gateway da rede tambem sera comprometido.

#
# INSTALACAO
#

# atualizacao do sistema operacaional.
$ sudo apt-get update && sudo apt-get upgrade 

# instalacao do proxy Squid.
$ sudo apt-get install squid -y -d

#
# CONFIGURACAO
#

# criacao do diretorio de cache do squid.
$ sudo mkdir -p /var/cache/squid

# alterando permissao.
$ sudo chown -R proxy.proxy /var/cache/squid

# copia de seguranca do arquivo de configuracao do squid.
$ sudo mv /etc/squid/squid.conf /etc/squid/squid.conf.BKP

# configuracao basica do squid
$ sudo vi /etc/squid/squid.conf
	# o software squid ira utilizar a porta 3128 para trabalhar.
	http_port 3128 transparent

	# ACL - access control list
	# definindo nome e rede
	acl localhost src 127.0.0.1/32
	acl localnet src 192.168.0.0/24
	acl free_access time MTWHF 12:00-13:00

	# definicao de portas
	acl SSL_ports port 443
	acl Safe_ports port 80          # http
	acl Safe_ports port 21          # ftp
	acl Safe_ports port 443         # https
	acl Safe_ports port 70          # gopher
	acl Safe_ports port 210         # wais
	acl Safe_ports port 280         # http-mgmt
	acl Safe_ports port 488         # gss-http
	acl Safe_ports port 591         # filemaker
	acl Safe_ports port 777         # multiling http
	acl Safe_ports port 1025-65535  # unregistered ports

	acl CONNECT method CONNECT

	# negar o acesso em portas que nao estejam registradas 
	# nos comandos acima.
	http_access deny !Safe_ports
	http_access deny CONNECT !SSL_ports

	# protocolo HTTP liberado o acesso para as acl LOCALNET
	# e LOCALHOST.
	http_access allow localnet free_access
	http_access allow localhost

	# o restante eh negado o acesso.
	http_access deny all

	# o diretorio a onde esta armazenado o cache do proxy
	# estara responsavel pelo usuario PROXY.
	cache_effective_user proxy

	# caracteristicas do cache
	cache_dir ufs /var/cache/squid 2000 16 256

# reinicializar o proxy squid
$ sudo systemctl restart squid.service

# redirecionamento via iptable da porta 80 para a porta 3128 na
# interface interna do gateway.
$ firewall.squid.sh
	# web proxy squid
	# ens34 - interface interna
	iptables -t nat -A PREROUTING -i ens34 -p tcp --dport 80 -j REDIRECT --to-port 3128
