#: Title : Implementing a proxy server
#: Author : "Caio Abreu Ferreira" <abreuferr_gmail.com>
#: Description : 208.3 Implementing a proxy server
#: Options : Weight: 2

Description: Candidates should be able to install and configure a 
proxy server, including access policies, authentication and resource 
usage.

Key Knowledge Areas:
- Squid 3.x configuration files, terms and utilities
- Access restriction methods
- Client user authentication methods
- Layout and content of ACL in the Squid configuration files

Terms and Utilities:
- squid.conf
- acl
- http_access

# proxy - 192.168.0.2
#
# no texto abaixo, o proxy foi instalado no mesmo computador do gateway,
# o que NAO eh uma boa escolha pois se por acaso o proxy for comprometido,
# o gateway da rede foi comprometido.

$ sudo apt-get install squid -y -d ; instalacao do proxy Squid

$ sudo mkdir -p /var/cache/squid ; criacao do diretorio de cache do squid
$ sudo chown -R squid.squid /var/cache/squid ; alterando permissao
$ sudo cd /var/cache/squid
$ sudo squid -z -F ; criar os diretorios de cache do squid

$ sudo mv /etc/squid/squid.conf /etc/squid/squid.conf.BKP ; copia de seguranca do arquivo de configuracao do squid

$ sudo vi /etc/squid/squid.conf ; configuracao basica do squid
	cache_effective_user squid

	acl network_lan src 192.168.0.0/24

	http_port 3128 transparent

	cache_dir ufs /var/cache/squid 2000 16 256

	http_access allow network_lan
	http_access deny all

$ sudo systemctl restart squid.service

$ firewall.squid.sh
	# web proxy squid
	# ens32 - interface externa
	# ens34 - interface interna
	$IPTABLES -t nat -A PREROUTING -i ens32 -p tcp --dport 80 -j DNAT --to 192.168.0.2:3128
	$IPTABLES -t nat -A PREROUTING -i ens34 -p tcp --dport 80 -j REDIRECT --to-port 3128
